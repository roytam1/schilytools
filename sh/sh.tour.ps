%!PS-Adobe-3.0
%%Creator: groff version 1.07
%%DocumentNeededResources: font Symbol
%%+ font Times-Bold
%%+ font Times-Italic
%%+ font Times-Roman
%%+ font Courier
%%DocumentSuppliedResources: procset grops 1.07 0
%%+ font Symbol-Slanted
%%Pages: 11
%%PageOrder: Ascend
%%Orientation: Portrait
%%EndComments
%%BeginProlog
%%BeginResource: procset grops 1.07 0
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/MF{
findfont
[5 2 roll
0 3 1 roll 
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}bind def
/DA{
newpath arcn stroke
}bind def
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
/DL{
SN
moveto
SN
lineto stroke
}bind def
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
/FL{
currentgray exch setgray fill setgray
}bind def
/BL/fill load def
/LW/setlinewidth load def
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
}bind def
/PEND{
clear
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%IncludeResource: font Symbol
%%IncludeResource: font Times-Bold
%%IncludeResource: font Times-Italic
%%IncludeResource: font Times-Roman
%%IncludeResource: font Courier
%%BeginResource: font Symbol-Slanted
%%DocumentNeededResources: font Symbol
/MakeTransformedFont{
findfont dup maxlength dict begin
{
exch dup dup/FID ne exch/UniqueID ne and{
exch def
}{
pop pop
}ifelse
}forall
/FontBBox
currentdict/FontBBox get
4 array copy def
FontBBox aload pop
4 index transform 4 2 roll
4 index transform 4 2 roll
FontBBox astore pop
FontMatrix exch matrix concatmatrix
/FontMatrix exch def
dup/FontName exch def
currentdict end
definefont pop
}bind def
/Symbol-Slanted
[.89 0.0 15.5 dup sin exch cos div .89 0.0 0.0]
/Symbol
MakeTransformedFont
%%EndResource
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72 def/PL
792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron/scaron/zcaron
/Ydieresis/trademark/quotesingle/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/space
/exclam/quotedbl/numbersign/dollar/percent/ampersand/quoteright/parenleft
/parenright/asterisk/plus/comma/hyphen/period/slash/zero/one/two/three/four
/five/six/seven/eight/nine/colon/semicolon/less/equal/greater/question/at/A/B/C
/D/E/F/G/H/I/J/K/L/M/N/O/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash
/bracketright/circumflex/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q
/r/s/t/u/v/w/x/y/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase
/guillemotleft/guillemotright/bullet/florin/fraction/perthousand/dagger
/daggerdbl/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen/brokenbar
/section/dieresis/copyright/ordfeminine/guilsinglleft/logicalnot/minus
/registered/macron/degree/plusminus/twosuperior/threesuperior/acute/mu
/paragraph/periodcentered/cedilla/onesuperior/ordmasculine/guilsinglright
/onequarter/onehalf/threequarters/questiondown/Agrave/Aacute/Acircumflex/Atilde
/Adieresis/Aring/AE/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute
/Icircumflex/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn/germandbls
/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla/egrave/eacute
/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis/eth/ntilde/ograve
/oacute/ocircumflex/otilde/odieresis/divide/oslash/ugrave/uacute/ucircumflex
/udieresis/yacute/thorn/ydieresis]def/Courier@0 ENC0/Courier RE/Times-Roman@0
ENC0/Times-Roman RE/Times-Italic@0 ENC0/Times-Italic RE/Times-Bold@0 ENC0
/Times-Bold RE
%%EndProlog
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Bold@0 SF 3(AP)202.325 123 S(artial T)221.201 123 Q(our Thr)-1.104
E(ough the)-.216 E/F1 11/Times-Bold@0 SF(UNIX)3 E F0 3<8753>C(hell)391.002 123
Q/F2 10/Times-Italic@0 SF(Geof)278.73 147 Q 2.5(fC)-.18 G(ollyer)309.94 147 Q
/F3 10/Times-Roman@0 SF(Department of Statistics)257.67 165 Q(Uni)262.715 177 Q
-.15(ve)-.25 G(rsity of T).15 E(oronto)-.8 E -.8(To)255.02 189 S
(ronto, Ontario, Canada).8 E(M5S 1A1)286.415 201 Q/F4 10/Courier@0 SF
(utzoo!utstat!geoff)252 213 Q(geoff@utstat.toronto.edu)234 225 Q F2(ABSTRA)
282.535 261 Q(CT)-.3 E F3 2.437 -.8(We h)151 285 T -2.25 -.2(av e).8 H .837
(recently completed protracted sur)3.537 F .837(gery on the)-.18 F/F5 9
/Times-Roman@0 SF(UNIX)3.337 E F3 .836(command interpreter)3.337 F .547
(or `shell' [Bourne1978a] to mak)126 297 R 3.047(ei)-.1 G 3.047(tu)267.774 297
S .547(se the standard)278.601 297 R F5(UNIX)3.047 E F3 .547
(memory allocator \()3.047 F F2(malloc)A F3(\(3\))1.666 E .41(and relati)126
309 R -.15(ve)-.25 G .41(s\) for its internal memory management instead of the\
 original scheme \(catch-).15 F .778(ing its o)126 321 R .778(wn memory f)-.25
F .778(aults, using the)-.1 F F2(sbrk)3.278 E F3 .778(\(2\) system call to gro)
1.666 F 3.278(wi)-.25 G .779(ts memory allocation)400.002 321 R 1.632
(and restarting f)126 333 R 1.632(aulting instructions\).)-.1 F 3.231 -.8(We a)
6.631 H 1.631(lso \214x).8 F 1.631(ed some b)-.15 F(ugs,)-.2 E F2(lint)4.131 E
F3 1.631(\(1\) complaints and)1.666 F 2.229(suboptimal performance.)126 345 R
2.229(This paper describes the lessons learned about the internal)7.229 F -.1
(wo)126 357 S .101(rkings of the shell.).1 F .101
(Much of this information is oral folklore or is simply not generally)5.101 F
(kno)126 369 Q .322(wn, and requires a determined ef)-.25 F .322
(fort to learn, yet is essential to correct understanding)-.25 F
(and maintenance of the shell.)126 381 Q F0 3(1. Intr)90 421 R(oduction)-.216 E
/F6 12/Times-Roman@0 SF 3.515(Av)115 438.6 S .515(ery sk)132.999 438.6 R(etch)
-.12 E 3.515(yo)-.06 G -.18(ve)197.653 438.6 S(rvie).18 E 3.515(wo)-.3 G 3.515
(ft)245.34 438.6 S .514
(he shell is that it parses its input into a parse tree, then)256.187 438.6 R
-.12(wa)90 452.6 S 3.241(lks the tree, e).12 F -.18(xe)-.18 G 3.241
(cuting the tree nodes by creating pipes,).18 F/F7 12/Times-Italic@0 SF(fork)
6.242 E F6 3.242(ing, redirecting I/O)2 F(descriptors,)90 466.6 Q F7 -.24(ex)
3.434 G(ec).24 E F6 .434(ing commands, and the lik)2 F 3.433(e. Interw)-.12 F
-.18(ove)-.12 G 3.433(nw).18 G .433(ith this are macro e)381.8 466.6 R
(xpansion;)-.18 E .425(honouring quoting; coping with k)90 480.6 R -.18(ey)-.12
G .426(board, alarm clock, and other interrupts \(via signals\);).18 F .313
(and maintaining v)90 494.6 R .313(ariables and functions.)-.3 F .313
(One can think of the shell as a macro processor)6.313 F
(which also interprets commands.)90 508.6 Q .434(The original Se)115 526.2 R
-.18(ve)-.3 G .435
(nth Edition shell had to run in a small address space \(64k bytes of).18 F
.094(instructions and 64k bytes of data, including stack se)90 540.2 R .094
(gment\), yet places no arbitrary limits)-.18 F 1.591
(on lengths of strings or input lines \(which may e)90 554.2 R 1.591
(xplain some of the contortions in the)-.18 F 4.521(code\). W)90 568.2 R 1.521
(ith the e)-.48 F 1.521(xceptions of)-.18 F F7 -.18(ev)4.52 G(al).18 E F6 1.52
(and quoting, which are incompletely speci\214ed, the)6.52 F -.18(ex)90 582.2 S
1.888(ternal speci\214cation of the shell is simple, rational, and clean.).18 F
1.889(No comments in this)7.889 F(paper should be tak)90 596.2 Q
(en as denigrating these achie)-.12 E -.18(ve)-.3 G(ments.).18 E .249
(The shell source code is opaque and under)115 613.8 R .248
(-commented in spots, which causes main-)-.24 F .31
(tainers to attempt only minimal changes and \214x)90 627.8 R 3.31(es. The)-.18
F .31(shell w)3.31 F .311(as the last program ported)-.12 F 1.656
(to the Interdata during the original)90 641.8 R/F8 11/Times-Roman@0 SF(UNIX)
4.655 E F6 1.655(port, [Johnson1978a] due to the dif)4.655 F 1.655
(\214culty of)-.3 F .872(getting the details of restarting f)90 655.8 R .872
(aulting instructions just right, which is wh)-.12 F 3.873(yt)-.06 G .873
(he Se)468.615 655.8 R -.18(ve)-.3 G(nth).18 E 1.279(Edition \(also kno)90
669.8 R 1.279(wn as `)-.3 F(`V7')-.888 E 1.279('\) distrib)-.888 F 1.279
(ution tape includes)-.24 F/F9 12/Courier@0 SF(/bin/osh)4.278 E F6 4.278(,t)C
1.278(he Sixth Edition)441.432 669.8 R 1.403(shell. [Ritchie1987a] One cliched\
 complaint about the original shell source, that it w)90 683.8 R(as)-.12 E .042
(written in a dialect of the C language resembling Algol 68, is not a problem \
once one gets)90 697.8 R .32 LW 94 707.8 90 707.8 DL 98 707.8 94 707.8 DL 102
707.8 98 707.8 DL 106 707.8 102 707.8 DL 110 707.8 106 707.8 DL 114 707.8 110
707.8 DL 118 707.8 114 707.8 DL 122 707.8 118 707.8 DL 126 707.8 122 707.8 DL
130 707.8 126 707.8 DL 134 707.8 130 707.8 DL 138 707.8 134 707.8 DL 142 707.8
138 707.8 DL 146 707.8 142 707.8 DL 150 707.8 146 707.8 DL 154 707.8 150 707.8
DL 158 707.8 154 707.8 DL 162 707.8 158 707.8 DL/F10 8/Times-Roman@0 SF<87>90
717.8 Q/F11 7/Times-Roman@0 SF(UNIX)2 E F10
(is a trademark of Bell Laboratories.)2 E EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Roman@0 SF 1.119
(used to it, particularly if one has a reading kno)90 86 R 1.119
(wledge of Algol 68.)-.3 F 1.119(In an)7.119 F 4.119(yc)-.18 G 1.119
(ase, recent)470.241 86 R(System V shells are written in ordinary C.)90 100 Q
(Ho)6 E(we)-.3 E -.18(ve)-.3 G .96 -.48(r, t).18 H
(his is the least of the problems.).48 E 3.024(Upon attempting to mak)115 117.6
R 6.024(et)-.12 G 3.024(he Ninth Edition shell \(deri)255.64 117.6 R -.18(ve)
-.3 G 6.023(df).18 G 3.023(rom the System V)425.931 117.6 R 1.502(Release 2 sh\
ell\) run on a Sun-3 under SunOS 3.x, we ran into trouble with the shell')90
131.6 R(s)-.66 E .084(peculiar internal memory management.)90 145.6 R .084
(The shell often f)6.084 F .084(ailed in a spectacular and anno)-.12 F(y-)-.12
E .764(ing w)90 159.6 R .764(ay: it gre)-.12 F 3.764(wi)-.3 G .764(ts stack se)
177.296 159.6 R .764(gment to maximum size and then dumped core.)-.18 F 2.684
-.96(We d)6.764 H(isco).96 E(v-)-.18 E .143(ered man)90 173.6 R 3.143(yp)-.18 G
(re)149.422 173.6 Q .143
(viously-undocumented characteristics of the shell in the process of con)-.3 F
-.18(ve)-.48 G(rt-).18 E(ing the shell to use)90 187.6 Q/F1 12/Times-Italic@0
SF(malloc)3 E F0(\(3\) and relati)2 E -.18(ve)-.3 G 3(s. The).18 F
(result of this w)3 E .001(ork is referred to through-)-.12 F .01
(out this paper as `)90 201.6 R .01(`the ne)-.888 F 3.01(ws)-.3 G(hell')223.512
201.6 Q .01(', for lack of a better name.)-.888 F .01
(This paper discusses only the)6.01 F .735
(parts of the shell visited in the course of making it w)90 215.6 R .736
(ork correctly on the Sun-3; the rest)-.12 F(of the shell is relati)90 229.6 Q
-.18(ve)-.3 G(ly straightforw).18 E(ard.)-.12 E 1.026(The rest of the paper co\
nsists of six sections: section 2 describes the design of the)115 247.2 R .137
(old shell, section 3 the problems in implementation of the old shell, section\
 4 the \214x)90 261.2 R .138(es we)-.18 F 1.002(applied to produce the ne)90
275.2 R 4.001(ws)-.3 G 1.001
(hell, section 5 our methods, section 6 our conclusions, and)232.347 275.2 R
1.753(section 7 ackno)90 289.2 R 4.753(wledgements. Those)-.3 F 1.753
(readers interested only in the internals of the old)4.753 F
(shell may safely skip sections 4 and 5.)90 303.2 Q/F2 12/Times-Bold@0 SF 3
(2. Design)90 331.2 R 3(2.1. Memory)90 362.8 R(Management)3 E F0 .419
(The \214rst subtlety encountered by most shell maintainers is the shell')115
380.4 R 3.418(si)-.66 G .418(nternal mem-)457.262 380.4 R 2.231
(ory management, which has been characterised as `e)90 394.4 R 2.231
(xtremely ele)-.18 F -.06(ga)-.18 G 2.231(nt, b).06 F 2.231(ut a house of)-.24
F 4.817(cards'. The)90 408.4 R 1.817(shell contains its o)4.817 F 1.817
(wn memory allocator)-.3 F 4.817(,a)-.48 G -.3(va)-.001 G 1.816
(riant of the Se).3 F -.18(ve)-.3 G 1.816(nth Edition).18 F F1(malloc)90 422.4
Q F0 3.089(,w)2 G .089(hich maintains tw)139.417 422.4 R 3.089(od)-.12 G .089
(istinct kinds of storage:)239.896 422.4 R F1(heap)3.089 E F0 .09
(storage, which has an inde\214-)5.089 F .062
(nite lifetime and resembles ordinary)90 436.4 R F1(malloc)3.062 E F0 .062
(ed memory; and)2 F F1 -1.332(``)3.062 G(stak')1.332 E(')-1.332 E F0 .061
(storage \(so spelled to)5.061 F .811(distinguish it from the shell')90 450.4 R
3.811(ss)-.66 G .811(tack se)241.739 450.4 R .812
(gment\) which is allocated and deallocated in strict)-.18 F 1.66
(last-in, \214rst-out order)90 464.4 R 7.66(.H)-.66 G 1.66(eap and)214.308
464.4 R F1(stak)4.66 E F0 1.66(storage blocks are intermingled in the data se)
6.66 F(g-)-.18 E(ment.)90 478.4 Q 4.181(Af)115 496 S 1.181
(undamental abstraction of the shell is a stack of)131.841 496 R F1(stak)4.182
E F0 1.182(storage, in which the top)6.182 F .924
(item on the stack is typically a gro)90 510 R .923(wing string.)-.3 F .923
(The top item may be mo)6.923 F -.18(ve)-.18 G 3.923(da).18 G 3.923(tt)474.83
510 S .923(he con-)485.425 510 R -.18(ve)90 524 S .76
(nience of the memory allocator).18 F 3.761(,s)-.48 G 3.761(oi)265.102 524 S
3.761(ts)278.199 524 S .761(hould \(in theory)289.964 524 R 3.761(,i)-.78 G
3.761(fn)378.131 524 S .761(ot al)391.888 524 R -.12(wa)-.12 G .761
(ys in practice\) only).12 F .638
(be referred to by the functions and macros of)90 538 R/F3 12/Courier@0 SF
(stak.h)3.638 E F0 3.638(;k)C .637(eeping pri)370.736 538 R -.3(va)-.3 G .637
(te pointers into the).3 F .76(top item is forbidden.)90 552 R .76
(Once the top item has been gro)6.76 F .761(wn to its maximum e)-.3 F .761
(xtent, it may)-.18 F(be made permanent and immo)90 566 Q -.3(va)-.18 G
(ble, and a ne).3 E 1.56 -.78(w, e)-.3 H(mpty top item is be).78 E(gun.)-.18 E
.716(The interf)115 583.6 R .716(ace to the)-.12 F F1(stak)3.715 E F0 .715
(storage manipulators,)5.715 F F3(stak.h)3.715 E F0 3.715(,d)C .715(eclares se)
403.09 583.6 R -.18(ve)-.3 G .715(ral functions).18 F .721(and macros, notably)
90 597.6 R F1(pushstak\(byte\))3.721 E F0 3.721(,w)2 G .721(hich appends a)
279.516 597.6 R F1(byte)3.722 E F0 .722(to the top item and adv)5.722 F(ances)
-.3 E .11(the top past it, acquiring more memory from)90 611.6 R/F4 11
/Times-Roman@0 SF(UNIX)3.109 E F0 .109(as needed.)3.109 F F1 -.444(re)6.109 G
(lstak\(\)).444 E F0 .109(yields the inte)5.109 F(ger)-.18 E(of)90 625.6 Q .234
(fset of the top of the top)-.3 F F1(stak)3.234 E F0 .235
(item, i.e. the size of the top item.)5.234 F F1(absstak\(of)6.235 E(fset\))
-.216 E F0 .235(yields a)5.235 F .727(temporary pointer to the top item,)90
639.6 R F1(of)3.727 E(fset)-.216 E F0 .726
(bytes in; this pointer must not be retained.)5.727 F F1(set-)6.726 E(stak\(of)
90 653.6 Q(fset\))-.216 E F0 .706(sets the top of the top item to be)5.706 F F1
(of)3.707 E(fset)-.216 E F0 .707(bytes in.)5.707 F F1(zer)6.707 E(ostak\(\))
-.54 E F0 .707(stores a zero on)5.707 F 2.173(the top of the top item b)90
667.6 R 2.172(ut does not mo)-.24 F 2.532 -.18(ve t)-.18 H 2.172(he top.).18 F
F1(cur)8.172 E(stak\(\))-.12 E F0 2.172(yields the a temporary)7.172 F .877
(pointer to the top of the top item; this pointer must not be retained.)90
681.6 R F1(usestak\(\))6.877 E F0(calls)5.877 E F1(loc-)3.877 E(stak\(\))90
695.6 Q F0 .837(and ignores the result.)5.837 F F1(\214xstak\(\))6.837 E F0
(calls)5.837 E F1(endstak)3.837 E F0 .837(with a pointer to the top of the top)
5.837 F(item.)90 709.6 Q EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Italic@0 SF(locstak\(\))115 86 Q/F1 12/Times-Roman@0 SF .406
(returns a temporary pointer of the bottom of the ne)5.406 F 3.407(wt)-.3 G(op)
424.783 86 Q F0(stak)3.407 E F1 .407(item, which)5.407 F 1.411
(will be big enough for an)90 100 R 4.411(ys)-.18 G 1.411
(tructure used in the shell \(notably)232.938 100 R/F2 12/Courier@0 SF 1.41
(struct fileblk)4.411 F F1(or)4.41 E F2(2*CPYSIZ)90 114 Q F1(from)4.74 E F2
(io.c)4.74 E F1 1.741(\); this pointer may be used until one of)B F0(pushstak)
4.741 E F1(,)2 E F0(endstak)4.741 E F1 4.741(,o)2 G(r)518.004 114 Q F0
(\214xstak)90 128 Q F1 .72(is called.)5.72 F F0(endstak\(ar)6.719 E(gp\))-.444
E F1 .719(terminates the top item at)5.719 F F0(ar)3.719 E(gp)-.444 E F1 .719
(with a zero byte, mak)5.719 F(es)-.12 E .98
(the top item permanent, starts a ne)90 142 R 3.98(wt)-.3 G .98
(op item, and returns the address of the terminated)276.536 142 R .01(and no)90
156 R 3.01(wp)-.3 G .009(ermanent item.)139.712 156 R F0 -.12(ge)6.009 G
(tstak\(n\)).12 E F1 .009(returns a permanent item of size)5.009 F F0(n)3.009 E
F1 .009(bytes by gro)5.009 F(wing)-.3 E .648(the current top item.)90 170 R F0
(savstak\(\))6.648 E F1 .648
(asserts that the top item is empty and returns the address)5.648 F .269
(of the bottom of the top item.)90 184 R F0(tdystak\(ptr\))6.269 E F1(remo)
5.269 E -.18(ve)-.18 G 3.268(st).18 G .268
(emporary \214les \(e.g. from here docu-)347.044 184 R .576
(ments\) described by structures on the)90 198 R F0(stak)3.577 E F1(do)5.577 E
.577(wn to address)-.3 F F0(ptr)3.577 E F1 3.577(,a)2 G .577(nd pops the)
410.664 198 R F0(stak)3.577 E F1(do)5.577 E(wn)-.3 E 1.54(to b)90 212 R 1.54
(ut not including)-.24 F F0(ptr)4.54 E F1(.)2 E F0(stakc)7.54 E(hk\(\))-.18 E
F1 1.54(reduces the data break if possible.)6.54 F F0(cpystak\(string\))7.54 E
F1(copies the)90 226 Q F0(string)3 E F1(to a ne)5 E 3(wp)-.3 G
(ermanent item and returns its address.)223.688 226 Q 1.6(The memory allocator\
 and other parts of the old shell assume that the address of)115 243.6 R(ne)90
257.6 Q(wly-allocated)-.3 E F0(stak)4.851 E F1 1.85
(storage will be greater than the addresses of all other still-acti)6.851 F
-.18(ve)-.3 G F0(stak)90 271.6 Q F1 3.133(storage. \(This)5.133 F .134
(is not true of storage obtained from arbitrary)3.133 F F0(malloc)3.134 E F1
3.134(s.\) This)2 F(property)3.134 E .498(is e)90 285.6 R .497
(xploited by tricks such as recording a single `)-.18 F(`w)-.888 E(atermark')
-.12 E 3.497('p)-.888 G(ointer)399.496 285.6 Q 3.497(,t)-.48 G 3.497(om)436.845
285.6 S .497(ark the points)455.678 285.6 R 1.774(in se)90 299.6 R -.18(ve)-.3
G 1.774(ral intertwined stacks of).18 F F0(stak)4.774 E F1 1.774(storage abo)
6.774 F 2.135 -.18(ve w)-.18 H 1.775(hich data may be e).18 F -.18(ve)-.3 G
1.775(ntually dis-).18 F 1.07(carded, then later popping the top items from th\
e stacks by popping each stack until its)90 313.6 R
(stack pointer reaches the w)90 327.6 Q(atermark pointer)-.12 E 3(,o)-.48 G 3
(rd)311.004 327.6 S(rops belo)324 327.6 Q 3(wi)-.3 G(t.)383.028 327.6 Q 1.763
(Heap storage is allocated by)115 345.2 R F0(alloc)4.763 E F1 1.763(\(also kno)
6.763 F 1.763(wn as)-.3 F F0(malloc)4.764 E F1 1.764(in the old shell\).)6.764
F(The)7.764 E .288(shell assumes fundamentally that)90 359.2 R F0(fr)3.288 E
(ee)-.444 E F1 .287(will ignore attempts to free the address zero \(`)5.288 F
(`null)-.888 E(pointers')90 373.2 Q 2.27('\), addresses in the shell')-.888 F
5.271(ss)-.66 G 2.271(tack se)274.44 373.2 R 2.271(gment \(automatic v)-.18 F
2.271(ariables, command-line)-.3 F(ar)90 387.2 Q .945(guments, and en)-.216 F
.945(vironment v)-.48 F .944(ariables\), and addresses of)-.3 F F0(stak)3.944 E
F1 .944(storage not yet made per)5.944 F(-)-.24 E .75
(manent and immobile; the shell')90 401.2 R(s)-.66 E F0(fr)3.75 E(ee)-.444 E F1
.75(is meant to free only heap storage and permanent)5.75 F F0(stak)90 415.2 Q
F1(storage.)5 E 1.927(The old shell catches its o)115 432.8 R 1.927
(wn memory f)-.3 F 1.926(aults \(via the SIGSEGV signal, typically)-.12 F 2.421
(caused by heap allocation be)90 446.8 R 2.422(yond the data break or gro)-.18
F 2.422(wth of the current)-.3 F F0(stak)5.422 E F1(item)7.422 E(be)90 460.8 Q
2.544(yond the data break\), gro)-.18 F 2.544(ws the data se)-.3 F 2.544
(gment with)-.18 F F0(sbrk)5.544 E F1 2.543(\(2\) by)2 F F0(brkincr)5.543 E F1
2.543(bytes, and)7.543 F(returns control, thus resuming the f)90 474.8 Q
(aulting instruction.)-.12 E/F3 12/Times-Bold@0 SF 3(2.2. No)90 502.8 R
(use of C library)3 E F1 .402(The shell mak)115 520.4 R .402
(es no use of the C library be)-.12 F .402
(yond system calls, perhaps because the C)-.18 F .042(library w)90 534.4 R .042
(as not well-de)-.12 F -.18(ve)-.3 G .042(loped when the shell w).18 F .042
(as written, perhaps to mak)-.12 F 3.042(et)-.12 G .042(he shell self-)460.596
534.4 R .183(contained, or perhaps to a)90 548.4 R -.24(vo)-.24 G .183
(id dangerous interactions among the shell, the shell').24 F(s)-.66 E F0
(malloc)3.184 E F1(,)2 E .268(the C library)90 562.4 R 3.268(,a)-.78 G .268
(nd the C library')162.012 562.4 R(s)-.66 E F0(malloc)3.268 E F1 3.268
(\(3\). The)2 F(ef)3.268 E .268(fect has been to mak)-.3 F 3.268(et)-.12 G .268
(he shell fragile)450.148 562.4 R 1.469
(and less portable than if it did rely on the C library)90 576.4 R 7.469(.F)
-.78 G 1.47(or e)365.316 576.4 R 1.47(xample, the shell')-.18 F 4.47(sm)-.66 G
(emory)491.34 576.4 Q 1.737(allocator does not co-e)90 590.4 R 1.737
(xist with the C library)-.18 F 4.737(,s)-.78 G 4.736(oi)327.912 590.4 S 4.736
(ti)341.984 590.4 S 4.736(sn)353.392 590.4 S 1.736(ot safe to call the)368.796
590.4 R F0(dir)4.736 E(ectory)-.444 E F1(\(3\))2 E
(directory-reading routines, which call)90 604.4 Q F0(malloc)3 E F1(\(3\).)2 E
F3 3(3. Implementation)90 632.4 R(Pr)3 E(oblems)-.216 E 3(3.1. Memory)90 660.4
R(Management)3 E F1 .012(The heap allocator)115 678 R 3.012(,i)-.48 G(n)213.196
678 Q F2(blok.c)3.012 E F1 .012(\(a modi\214ed V7)3.012 F F0(malloc)3.012 E F1
.012(\(3\)\), and the)2 F F0(stak)3.013 E F1(allocator)5.013 E 3.013(,i)-.48 G
(n)516 678 Q F2(stak.c)90 692 Q F1 3.003(,t)C .003(ogether form the shell')
142.539 692 R 3.003(sm)-.66 G .003(emory allocator)268.539 692 R 6.003(.T)-.66
G(he)359.865 692 Q 3.003(ya)-.18 G .003(re intimate with each other')385.344
692 R(s)-.66 E 1.494(internals, in part because the heap allocator must mo)90
706 R 1.855 -.18(ve t)-.18 H 1.495(he top item on the).18 F F0(stak)4.495 E F1
(when)6.495 E .178(allocating heap storage, in order to k)90 720 R .178
(eep the top item of)-.12 F F0(stak)3.177 E F1 .177
(storage at the top of the data)5.177 F EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Roman@0 SF(se)90 86 Q(gment.)-.18 E/F1 12/Times-Italic@0 SF(alloc)
115 103.6 Q F0(mo)6.755 E -.18(ve)-.18 G 4.755(st).18 G 1.755(he top)184.818
103.6 R F1(stak)4.755 E F0 1.755(item to abo)6.755 F 2.115 -.18(ve t)-.18 H
1.755(he ne).18 F 4.755(wt)-.3 G 1.756(op of the heap arena when the)367.514
103.6 R 1.625(arena is gro)90 117.6 R 1.625(wn, and promotes other)-.3 F F1
(stak)4.625 E F0 1.625(items to)6.625 F F1(fr)4.624 E(ee)-.444 E F0 1.624
(able permanent storage, chained)2 F(together)90 131.6 Q(.)-.66 E/F2 12
/Courier@0 SF(blok.c)7.604 E F0 1.604
(rounds the number of bytes to allocate do)4.604 F 1.605
(wn by anding it with the)-.3 F .343(complement of \()90 145.6 R F1(brkincr)A
F0 .343(minus one\); this only w)5.343 F .343(orks correctly if)-.12 F F1
(brkincr)3.343 E F0 .343(is a po)5.343 F .343(wer of 2,)-.3 F(yet)90 159.6 Q F2
(stak.c)3.458 E F0 .459(adds 256 to)3.458 F F1(brkincr)3.459 E F0 3.459(,w)2 G
.459(hich starts of)266.94 159.6 R 3.459(fa)-.3 G 3.459(t5)342.333 159.6 S
3.459(12! Thus)355.128 159.6 R .459(the rounded-do)3.459 F .459(wn v)-.3 F
(alue)-.3 E 1.169(will be too lar)90 173.6 R 1.168
(ge, which only hurts performance, fortunately)-.216 F(.)-.78 E F2(stak.c)7.168
E F0 1.168(should probably)4.168 F(double)90 187.6 Q F1(brkincr)3 E F0
(instead.)5 E .988(The shell')115 205.2 R 3.988(sa)-.66 G .989
(llocator cannot co-e)177.636 205.2 R .989(xist with some)-.18 F F1(malloc)
3.989 E F0 .989(implementations because it)5.989 F .984
(assumes that only it allocates storage, and some)90 219.2 R F1(malloc)3.983 E
F0 3.983(sd)2 G 3.983(ol)379.491 219.2 S(ik)392.81 219.2 Q -.3(ew)-.12 G .983
(ise. [K).3 F .983(orn1985a] Fur)-.42 F(-)-.24 E(ther)90 233.2 Q 3.064(,t)-.48
G .064(he shell contains)117.58 233.2 R F1(malloc)3.064 E F0(and)5.064 E F1(fr)
3.064 E(ee)-.444 E F0 .064(de\214nitions, b)5.064 F .064(ut not a)-.24 F F1
-.444(re)3.064 G(alloc).444 E F0 .064(de\214nition, so uses of)5.064 F F1 -.444
(re)90 247.2 S(alloc).444 E F0 .33
(in the C library will drag in the C library')5.33 F(s)-.66 E F1 -.444(re)3.329
G(alloc).444 E F0 3.329(,w)2 G .329(hich will refer to the wrong)388.715 247.2
R F1(malloc)90 261.2 Q F0(and)7.332 E F1(fr)5.332 E(ee)-.444 E F0 8.332(.M)2 G
2.332(ore subtly)194.872 261.2 R 5.332(,b)-.78 G 2.332
(ecause the old shell allocates storage abo)258.42 261.2 R 2.693 -.18(ve i)-.18
H 2.333(ts data).18 F .249(break,\210 e)90 275.2 R -.18(ve)-.3 G 3.249(nat).18
G(olerant)166.239 275.2 Q F1(malloc)3.249 E F0 .25
(\(3\) which tried to co-operate with programs which do their)2 F -.3(ow)90
289.2 S 4.136(na).3 G 1.136(llocation via)119.828 289.2 R F1(brk)4.136 E F0
1.136(\(2\) or)2 F F1(sbrk)4.136 E F0 1.136(\(2\) w)2 F 1.136
(ould be misled and w)-.12 F 1.136(ould lik)-.12 F 1.135(ely step on the old)
-.12 F(shell')90 303.2 Q 4.582(ss)-.66 G 1.582(torage abo)129.922 303.2 R 1.942
-.18(ve i)-.18 H 1.582(ts data break.).18 F 1.583
(Perhaps due in part to this problem, the old shell)7.582 F .147
(goes to great pains to a)90 317.2 R -.24(vo)-.24 G .146
(id using the C library).24 F 3.146(,e)-.78 G .146(xcept to e)325.67 317.2 R
-.18(xe)-.18 G .146(cute system calls, necessitat-).18 F 1.917(ing rein)90
331.2 R -.18(ve)-.48 G 1.917
(ntion of parts of it, notably the string functions.).18 F 1.918(The ne)7.918 F
4.918(ws)-.3 G 1.918(hell relax)443.02 331.2 R 1.918(es this)-.18 F
(restriction and so can use the C library freely)90 345.2 Q(.)-.78 E 1.1
(The assumption that f)115 362.8 R 1.1
(aulting instructions can be \(and are\) restarted by return from)-.12 F .254
(the appropriate signal handler does not hold on all machines of interest.)90
376.8 R .254(In particular)6.254 F 3.254(,t)-.48 G(he)510.672 376.8 Q .996
(Sun-2, Sun-3, [Shannon1988a] and Cray-1 k)90 390.8 R(ernel-and-hardw)-.12 E
.996(are combination are kno)-.12 F(wn)-.3 E .005(not to correctly restart f)90
404.8 R .006(aulting instructions, which can lead to f)-.12 F .006
(ailure to initialise memory)-.12 F(,)-.78 E 2.243
(and thus to use of the address zero.)90 418.8 R 2.243
(Furthermore, on the Sun-3, and other machines)8.243 F .085
(which do not permit reference to address zero, the old shell')90 432.8 R 3.085
(sn)-.66 G(ai)392.205 432.8 Q .445 -.18(ve a)-.3 H .085(ssumption that gro).18
F(w-)-.3 E 1.035(ing the heap will cure a memory f)90 446.8 R 1.035
(ault does not hold for references to address zero, and)-.12 F .959(the strate)
90 460.8 R .959(gy of gro)-.18 F .959(wing the heap on each f)-.3 F .959
(ault merely gro)-.12 F .959(ws the heap inde\214nitely)-.3 F 3.96(,o)-.78 G
(ften)503.34 460.8 Q 1.214(until sw)90 474.8 R 1.214(ap or page space is e)-.12
F 1.214(xhausted, when the old shell')-.18 F 4.213(sm)-.66 G 1.213
(emory allocator blo)397.017 474.8 R 1.213(ws an)-.3 F
(assertion and dumps core, slo)90 488.8 Q(wly)-.3 E(.)-.78 E .67
(Unfortunately the)115 506.4 R F2(stak.h)3.67 E F0 .671(macros, especially)3.67
F F1(pushstak)3.671 E F0 3.671(,w)2 G .671(ere not used e)403.515 506.4 R -.18
(ve)-.3 G(rywhere).18 E .071(that the)90 520.4 R 3.071(ys)-.18 G .071(hould ha)
139.294 520.4 R .431 -.18(ve b)-.24 H .07(een used, and in places the equi).18
F -.3(va)-.3 G .07(lent code w).3 F .07(as written out in-line,)-.12 F .053
(or other internal programming con)90 534.4 R -.18(ve)-.48 G .053
(ntions were violated.).18 F .054(Cray Research found and \214x)6.054 F(ed)-.18
E .573(the most troublesome of the ab)90 548.4 R .572(uses of)-.24 F F1
(pushstak)3.572 E F0 3.572(,a)2 G .572(nd these \214x)334.648 548.4 R .572
(es found their w)-.18 F .572(ay into the)-.12 F(Ninth Edition shell.)90 562.4
Q 1.92 -.96(We f)6 H(ound and \214x).96 E(ed the rest.)-.18 E/F3 12
/Times-Bold@0 SF 3(3.2. Her)90 590.4 R 3(eD)-.216 G(ocuments)150.768 590.4 Q F1
(Her)115 608 Q 5.09(ed)-.444 G(ocuments)149.634 608 Q F0 2.091
(are a means of supplying standard input to a command from a)7.09 F
(script and are denoted by `)90 622 Q F2(<<)A F0('.)A .895
(Here documents appear to ha)115 639.6 R 1.255 -.18(ve b)-.24 H .895
(een added to the original Se).18 F -.18(ve)-.3 G .895(nth Edition shell at).18
F 5.444(the last moment.)90 653.6 R 5.445(The code is localised, b)192 653.6 R
5.445(ut careless about error)-.24 F 5.445(-checking and)-.24 F .4 LW 95 665.6
90 665.6 DL 97 665.6 92 665.6 DL 102 665.6 97 665.6 DL 107 665.6 102 665.6 DL
112 665.6 107 665.6 DL 117 665.6 112 665.6 DL 122 665.6 117 665.6 DL 127 665.6
122 665.6 DL 132 665.6 127 665.6 DL 137 665.6 132 665.6 DL 142 665.6 137 665.6
DL 147 665.6 142 665.6 DL 152 665.6 147 665.6 DL 157 665.6 152 665.6 DL 162
665.6 157 665.6 DL/F4 10/Times-Roman@0 SF 2.654<8854>90 677.6 S(he)103.764
677.6 Q/F5 10/Times-Italic@0 SF .154(data br)2.654 F(eak)-.37 E F4 .153
(or just)4.32 F F5(br)2.653 E(eak)-.37 E F4 .153(is the address of the lo)4.319
F .153(west-numbered byte of the data se)-.25 F .153(gment not)-.15 F .406
(allocated to a)90 689.6 R/F6 9/Times-Roman@0 SF(UNIX)2.906 E F4 2.906
(process. There)2.906 F .407
(may be accessible memory between the break and the bottom)2.906 F .173
(of the stack se)90 701.6 R .173(gment, b)-.15 F .173
(ut touching it is bad form and may result in a memory f)-.2 F .172(ault \(`)
-.1 F(`se)-.74 E(gmentation)-.15 E(violation')90 713.6 Q('\).)-.74 E EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Roman@0 SF 3.071(performance. Here)90 86 R .071
(documents are implemented by cop)3.071 F .071(ying lines from the shell')-.12
F 3.071(si)-.66 G .071(nput to)488.257 86 R 4.764(at)90 100 S 1.764(emporary \
\214le during parsing until a line containing only the delimiter is seen; then)
103.428 100 R(later)90 114 Q 3.486(,d)-.48 G .486(uring e)123.33 114 R -.18(xe)
-.18 G .485(cution of the command, if the delimiter w).18 F .485
(as not quoted, cop)-.12 F .485(ying the \214rst)-.12 F 3.447(temporary \214le\
 to a second temporary \214le while processing macros \(e.g. e)90 128 R
(xpanding)-.18 E/F1 12/Courier@0 SF($DMD)90 142 Q F0 3.315(\). If)B .315
(the second temporary \214le w)3.315 F .314
(as created, it is opened as the command')-.12 F 3.314(ss)-.66 G(tandard)
486.012 142 Q .684(input and unlink)90 156 R .685(ed, so it will not ha)-.12 F
1.045 -.18(ve t)-.24 H 3.685(ob).18 G 3.685(er)298.962 156 S(emo)311.971 156 Q
-.18(ve)-.18 G 3.685(dl).18 G .685(ater; otherwise the \214rst temporary)
356.624 156 R 1.076(\214le will be opened as the command')90 170 R 4.076(ss)
-.66 G 1.076(tandard input.)283.184 170 R 1.075
(In either case, the \214rst temporary)7.076 F .014(\214le will ha)90 184 R
.374 -.18(ve t)-.24 H 3.014(ob).18 G 3.014(eu)173.636 184 S(nlink)187.978 184 Q
.014(ed later)-.12 F 3.014(,b)-.48 G .015
(ut the shell may not get the chance if it is killed \214rst or)259.49 184 R
2.193(if the block containing the command with the here document w)90 198 R
2.193(as terminated via the)-.12 F F1(exec)90 212 Q F0 -.24(bu)3 G
(ilt-in command, which replaces the shell with the command.).24 E/F2 12
/Times-Italic@0 SF(write)115 229.6 Q F0 .11
(system calls to the \214rst temporary \214le were uncheck)5.109 F .11
(ed, so creating a here doc-)-.12 F 1.232
(ument when the \214le system containing)90 243.6 R F1(/tmp)4.231 E F0 1.231
(is full may lead to odd beha)4.231 F 1.231(viour and no)-.24 F 1.432
(diagnostic from the old shell.)90 257.6 R(\()7.432 E F2(writes)A F0 1.433
(to the second temporary \214le use a more general)6.432 F(mechanism,)90 271.6
Q F2(\215ush)3.005 E F0(in)5.005 E F1(macro.c)3.005 E F0 3.005(,a)C .005
(nd are still uncheck)252.412 271.6 R .004(ed in the ne)-.12 F 3.004(ws)-.3 G
3.004(hell. Oops!\) Also,)417.66 271.6 R(in)3.004 E 1.365
(the old shell, when cop)90 285.6 R 1.366
(ying input to the \214rst temporary \214le, lines are collected until at)-.12
F 3.48(least CPYSIZ \(512\) bytes are present, then are written to disk as who\
le lines, so)90 299.6 R(CPYSIZ+)90 313.6 Q/F3 12/Symbol-Slanted SF(e)A F0 1.349
(bytes are written at a time, causing)4.349 F F2(write)4.349 E F0 4.35(st)2 G
4.35(ob)365.586 313.6 S 4.35(eu)381.936 313.6 S 1.35
(naligned with \214le system)397.614 313.6 R 1.84
(block boundaries, and contrib)90 327.6 R 1.84(uting to the slo)-.24 F 1.839
(wness of here documents and thus to the)-.3 F(slo)90 341.6 Q(wness of unb)-.3
E(undling of shell `)-.24 E(`b)-.888 E(undles')-.24 E 3('o)-.888 G 3(r`)305.424
341.6 S(`archi)315.528 341.6 Q -.18(ve)-.3 G(s').18 E('. [K)-.888 E
(ernighan1984a])-.3 E/F4 12/Times-Bold@0 SF 3(3.3. Dir)90 369.6 R
(ectory Reading and W)-.216 E(ildcard Expansion)-.216 E F0 2.463(The Se)115
387.2 R -.18(ve)-.3 G 2.463(nth Edition shell reads directories to e).18 F
2.463(xpand wildcards \(`)-.18 F 2.464(`generate \214le-)-.888 F(names')90
401.2 Q .971('\), using the)-.888 F F2 -.444(re)3.971 G(ad).444 E F0 .971
(system call to read 16 bytes at a time and assuming a Se)5.971 F -.18(ve)-.3 G
(nth).18 E .725(Edition directory layout.)90 415.2 R .725
(The Ninth Edition \(and presumably System V Release 2\) shell)6.725 F 1.427
(used some of the)90 429.2 R F2(dir)4.427 E(ectory)-.444 E F0 1.427
(\(3\) routines from the C library)2 F 4.426(,b)-.78 G 1.426(ut used pri)
390.428 429.2 R -.3(va)-.3 G 1.426(te v).3 F 1.426(ersions of)-.18 F 5.401
(others. This)90 443.2 R -.12(wa)5.401 G 5.401(sd).12 G 2.402
(one so that memory allocation w)187.407 443.2 R 2.402
(ould be under the control of the)-.12 F(shell')90 457.2 Q 5.56(sp)-.66 G(ri)
132.232 457.2 Q -.3(va)-.3 G(te).3 E F2(opendir)5.56 E F0(and)7.56 E F2
(closedir)5.56 E F0 8.56(.U)2 G(nfortunately)293.184 457.2 Q 5.56(,i)-.78 G
5.56(td)362.956 457.2 S 2.559(id require the shell to kno)377.852 457.2 R(w)-.3
E 3.853(details of b)90 471.2 R(uf)-.24 E 3.853(fer allocation in the)-.3 F F2
(dir)6.853 E(ectory)-.444 E F0 3.854(\(3\) routines, and those details changed)
2 F .796(between 4BSD and SunOS 3.0, for e)90 485.2 R 3.795(xample. \(W)-.18 F
3.795(eb)-.96 G(elie)345.186 485.2 Q 1.155 -.18(ve 4)-.3 H .795
(BSD used a static b).18 F(uf)-.24 E .795(fer b)-.3 F(ut)-.24 E
(SunOS 3.0 allocates the b)90 499.2 Q(uf)-.24 E(fer dynamically)-.3 E(.\))-.78
E F4 3(3.4. I/O)90 527.2 R(Redir)3 E(ection)-.216 E F0 .249
(When the old shell e)115 544.8 R -.18(xe)-.18 G .249(cutes a redirected b).18
F .249(uilt-in command such as)-.24 F F1(set)3.249 E F0 3.249(,i)C 3.25(ts)
471.928 544.8 S -2.7 -.24(av e)483.182 544.8 T 3.25(st).24 G(he)510.672 544.8 Q
.324(redirected descriptor by using)90 558.8 R F2(dup2)3.324 E F0 .324
(\(2\) to mak)2 F 3.323(ead)-.12 G .323(uplicate descriptor)337.085 558.8 R
3.323(,o)-.48 G 3.323(na\214)438.231 558.8 S -.18(xe)462.877 558.8 S 3.323(dd)
.18 G(escrip-)489.348 558.8 Q(tor)90 572.8 Q 3.216(,U)-.48 G .216
(SERIO, which is typically 10 and must be abo)117.732 572.8 R .576 -.18(ve t)
-.18 H .216(he shell').18 F 3.216(su)-.66 G(ser)413.736 572.8 Q .216
(-accessible descrip-)-.24 F .75(tor range \(0-9\).)90 586.8 R(Unfortunately)
6.75 E 3.75(,t)-.78 G .75(he old shell isn')247.848 586.8 R 3.749(tp)-.216 G
.749(repared to deal with multiple redirec-)339.299 586.8 R 2.258(tors of b)90
600.8 R 2.258(uilt-in commands, so)-.24 F F1 2.258(set </etc/passwd >/dev/null)
5.258 F F0(causes)5.259 E F1(set)5.259 E F0(to)5.259 E -.18(exe)90 614.8 S
(cute and then causes the old shell to read).18 E F1(/etc/passwd)3 E F0(\(!\).)
A .8(When applied to an)115 632.4 R 3.8(yc)-.18 G .8(ommand, b)225.996 632.4 R
.8(uilt-in or not,)-.24 F F1(<'')3.8 E F0(and)3.8 E F1(>'')3.8 E F0(ha)3.8 E
1.159 -.18(ve n)-.24 H 3.799(oe).18 G -.3(ff)468.718 632.4 S .799(ect in the).3
F(old shell.)90 646.4 Q(This appears to be a relic from the days before)6 E F1
($*)3 E F0(and)3 E F1($@)3 E F0<2e87>A .4 LW 95 670 90 670 DL 97 670 92 670 DL
102 670 97 670 DL 107 670 102 670 DL 112 670 107 670 DL 117 670 112 670 DL 122
670 117 670 DL 127 670 122 670 DL 132 670 127 670 DL 137 670 132 670 DL 142 670
137 670 DL 147 670 142 670 DL 152 670 147 670 DL 157 670 152 670 DL 162 670 157
670 DL/F5 10/Times-Roman@0 SF 3.863<8754>90 682 S 1.363
(his undocumented misfeature of the shell w)104.973 682 R 1.364(as disco)-.1 F
-.15(ve)-.15 G 1.364(red by a nai).15 F 1.664 -.15(ve a)-.25 H 1.364
(nd serendipitous user).15 F 1.083(who w)90 694 R 1.083
(as pleasantly surprised to \214nd that)-.1 F/F6 10/Courier@0 SF(<$1)3.583 E F5
1.083(in a shell script `did the right thing' whether the)3.583 F(script w)90
706 Q(as in)-.1 E -.2(vo)-.4 G -.1(ke).2 G 2.5(dw).1 G(ith no ar)173.91 706 Q
(guments or with one, and commented upon this surprise.)-.18 E EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Bold@0 SF 3(3.5. Name-to-i-number)90 86 R(translations)3 E/F1 12
/Times-Roman@0 SF 1.029(The code to run do)115 103.6 R(wn)-.3 E/F2 12/Courier@0
SF($PATH)4.03 E F1 1.03(looking for a command e)4.03 F -.18(xe)-.18 G 1.03
(cuted more system calls).18 F 2.587(which translate \214le names to i-numbers\
 than necessary; upon \214nding a command, it)90 117.6 R -.12(wo)90 131.6 S
(uld).12 E/F3 12/Times-Italic@0 SF(access)3 E F1(\(2\) the \214le, then)2 E F3
(stat)3 E F1(\(2\) it.)2 E F0 3(3.6. Exit)90 159.6 R F1 .647(On man)115 177.2 R
3.648(y\()-.18 G .648(by intent, all\))167.439 177.2 R/F4 11/Times-Roman@0 SF
(UNIX)3.648 E F1 .648(systems, a program which does not use the standard)3.648
F .815(I/O library \()90 191.2 R F3(stdio)A F1 7.628(\)[)2 G -.3(Ke)190.574
191.2 S .814(rnighan1979a] will not cause an).3 F 3.814(yp)-.18 G .814(art of)
377.128 191.2 R F3(stdio)3.814 E F1 .814(to be loaded with)5.814 F 3.973
(it. This)90 205.2 R .973(is not true on SunOS 3.0, for e)3.973 F .974
(xample; a program such as the shell which does)-.18 F .359(not use)90 219.2 R
F3(stdio)3.359 E F1 .358(still gets some of)5.359 F F3(stdio)3.358 E F1 .358
(loaded with it, due to)5.358 F F3 -.24(ex)3.358 G(it).24 E F1(calling)5.358 E
F3 -.216<668d>3.358 G(ush).216 E F1 3.358(,a)2 G .358(nd that in)475.948 219.2
R .215(turn causes some)90 233.2 R F3(malloc)3.215 E F1 .216(to be loaded.)
5.215 F(Sun')6.216 E(s)-.66 E F3(malloc)3.216 E F1 .216
(includes 8,192 bytes of BSS \(unini-)5.216 F 2.143(tialised data se)90 247.2 R
2.143(gment\) containing its initial free block headers.)-.18 F 2.142
(This seems e)8.142 F(xcessi)-.18 E -.18(ve)-.3 G(,).18 E(gi)90 261.2 Q -.18
(ve)-.3 G 3(nt).18 G(hat programs often use)122.52 261.2 Q F3(malloc)3 E F1
(in an attempt to)5 E F3(conserve)3 E F1(memory)5 E(.)-.78 E F0 3(4. Fixes)90
289.2 R(in the new shell)3 E 3(4.1. Memory)90 317.2 R(Management)3 E F1 .787
(Our original \214x to the memory allocator)115 334.8 R 3.788(,t)-.48 G 3.788
(om)322.016 334.8 S(ak)341.14 334.8 Q 3.788(ei)-.12 G 3.788(tc)364.8 334.8 S
(o-e)377.252 334.8 Q .788(xist with the C library and)-.18 F -.12(wo)90 348.8 S
.532(rk in general, w).12 F .532(as to delete)-.12 F F2(blok.c)3.532 E F1 .532
(thus in)3.532 F -.24(vo)-.48 G(king).24 E F3(malloc)3.532 E F1 .532
(\(3\) and to re)2 F(write)-.3 E F2(stak.c)3.532 E F1 1.149
(from scratch to use)90 362.8 R F3(malloc)4.149 E F1 4.149(\(3\). Much)2 F 1.15
(later we disco)4.149 F -.18(ve)-.18 G 1.15(red that an alternati).18 F -.18
(ve)-.3 G 4.15(,l).18 G 1.15(ess clean)477.866 362.8 R .571(and less rob)90
376.8 R .571(ust \214x is to just delete pri)-.24 F -.3(va)-.3 G(te).3 E F3
(dir)3.57 E(ectory)-.444 E F1 .57(\(3\) functions, mak)2 F(e)-.12 E F3 -.18(ch)
3.57 G(kid).18 E F1 .57(reject zero)5.57 F .812(addresses, and pro)90 390.8 R
.812(vide a pri)-.18 F -.3(va)-.3 G(te).3 E F3 -.444(re)3.812 G(alloc).444 E F1
(in)5.812 E F2(blok.c)3.812 E F1 .813(which implements the semantics of)3.812 F
F3 -.444(re)90 404.8 S(alloc).444 E F1 .3(\(3\) using the pri)2 F -.3(va)-.3 G
(te).3 E F3(malloc)3.299 E F1(and)5.299 E F3(fr)3.299 E(ee)-.444 E F1 3.299(,t)
2 G .299(hough one must also increase the v)314.575 404.8 R .299(alues of)-.3 F
F2(BRKINCR)90 418.8 Q F1(and)3.04 E F2(BRKMAX)3.04 E F1 .04
(to at least the page size on some systems.)3.04 F .041(This apparently w)6.041
F(orks)-.12 E .913(by causing e)90 432.8 R -.18(ve)-.3 G .913(ry memory f).18 F
.913(ault to increase the data se)-.12 F .913(gment enough to co)-.18 F -.18
(ve)-.18 G 3.912(rt).18 G .912(he lar)474.984 432.8 R(gest)-.216 E
(allocation request normally seen inside the shell.)90 446.8 Q(The ne)6 E 3(ws)
-.3 G(hell does not use this \214x.)378.66 446.8 Q 1.737(The ne)115 464.4 R
4.737(ws)-.3 G 1.737(hell uses)167.494 464.4 R F3(pushstak)4.737 E F1 1.737
(and the other interf)6.737 F 1.737(ace macros and functions where)-.12 F .535
(needed, and)90 478.4 R F3(pushstak)3.535 E F1(no)5.535 E 3.535(wa)-.3 G .535
(rranges to gro)228.144 478.4 R 3.535(wt)-.3 G .535(he top item of)311.097
478.4 R F3(stak)3.535 E F1 .535(storage as needed.)5.535 F(The)6.534 E .344
(performance impact of this has not been measured, b)90 492.4 R .345
(ut appears to be insigni\214cant; in an)-.24 F(y)-.18 E 1.756
(case, this checking is necessary)90 506.4 R(.)-.78 E F2(stak.c)7.755 E F1
1.755(has been completely re)4.755 F 1.755(written from scratch)-.3 F
(\(see the Appendix\).)90 520.4 Q 2.711 -.96(We n)115 538 T 1.391 -.3(ow s).96
H .791(imulate the single pointer to se).3 F -.18(ve)-.3 G .791(ral interw).18
F -.18(ove)-.12 G 3.791(ns).18 G .791(tacks of)404.191 538 R F3(stak)3.791 E F1
.792(storage by)5.791 F .47(attaching a pointer to the pre)90 552 R(vious)-.3 E
F3(stak)3.47 E F1 .47(item to each ne)5.47 F(w)-.3 E F3(stak)3.47 E F1 .47
(item as it is allocated, and)5.47 F(retaining one w)90 566 Q
(atermark pointer per stack.)-.12 E 2.341 -.96(We l)115 583.6 T .421
(ayer another function \().96 F F3(shfr)A(ee)-.444 E F1 .421(\), on top of)2 F
F3(fr)3.421 E(ee)-.444 E F1 .421(\(3\), and the ne)2 F 3.421(ws)-.3 G .422
(hell is compiled)444.488 583.6 R(with)90 597.6 Q F2 4.46(#define free shfree)
7.46 F F1 4.459(and without the old shell')7.459 F(s)-.66 E F2 4.459
(#define alloc)7.459 F(malloc)90 611.6 Q F1(,)A F3(alloc)4.447 E F1 1.447
(being the name by which the heap allocator is in)6.447 F -.24(vo)-.48 G -.12
(ke).24 G(d.).12 E F3(shfr)7.447 E(ee)-.444 E F1(rejects)6.448 E 2.376
(attempts to free the address zero, addresses in the stack se)90 625.6 R 2.376
(gment or of)-.18 F F3(stak)5.376 E F1(storage;)7.376 E F3(fr)90 639.6 Q(ee)
-.444 E F1 .741(\(3\) is used directly to free)2 F F3(stak)3.741 E F1 3.741
(storage. T)5.741 F 3.742(od)-.96 G .742(istinguish heap storage from)332.882
639.6 R F3(stak)3.742 E F1(stor)5.742 E(-)-.24 E .285(age, the ne)90 653.6 R
3.285(ws)-.3 G(hell')158.535 653.6 Q 3.285(sa)-.66 G .284
(llocator attaches an inte)193.152 653.6 R .284(ger containing a magic number)
-.18 F 3.284(,d)-.48 G(if)469.708 653.6 Q .284(ferent for)-.3 F .052(heap and)
90 667.6 R F3(stak)3.052 E F1 .053(storage, to each item of storage allocated.)
5.052 F .053(This costs a little bit of memory)6.053 F(,)-.78 E -.24(bu)90
681.6 S 3(te).24 G
(xperiments on a PDP-11 suggest that this is not a serious problem.)113.244
681.6 Q 1.974 -.96(We s)115 699.2 T .054(imply use).96 F F3(malloc)3.054 E F1
.053(\(3\) and related functions, and thus require none of the compli-)2 F .439
(cated machinery for restarting f)90 713.2 R .44(aulting instructions.)-.12 F
.44(This has the pleasant side-ef)6.44 F .44(fect that)-.3 F 5.893(ab)90 727.2
S 2.893(uggy shell wielding a wild pointer typically dumps core immediately)
106.981 727.2 R 5.893(,i)-.78 G 2.893(nstead of)475.451 727.2 R EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Roman@0 SF(gro)90 86 Q 2.684(wing its stack se)-.3 F 2.684
(gment until the k)-.18 F 2.684(ernel kills it \(producing a multi-me)-.12 F
-.06(ga)-.18 G 2.684(byte core).06 F(dump\) minutes later)90 100 Q(.)-.66 E/F1
12/Times-Bold@0 SF 3(4.2. Her)90 128 R 3(eD)-.216 G(ocuments)150.768 128 Q F0
1.994 -.96(We h)115 145.6 T -2.7 -.24(av e).96 H .074
(repaired both of the here document b)3.314 F .073
(ugs, with one minor loss of generality:)-.24 F 1.988
(the here document delimiter must not e)90 159.6 R 1.988(xceed CPYSIZ bytes.)
-.18 F 1.988(CPYSIZ bytes are no)7.988 F(w)-.3 E .979(written to the \214rst t\
emporary \214le \(until end-of-\214le is read\), and the remaining fractional)
90 173.6 R(line is copied back to the start of the cop)90 187.6 Q(ying b)-.12 E
(uf)-.24 E(fer)-.3 E 3(,w)-.48 G(hich is 2*CPYSIZ bytes long.)351.48 187.6 Q F1
3(4.3. Dir)90 215.6 R(ectory Reading and W)-.216 E(ildcard Expansion)-.216 E F0
3.154 -.96(We s)115 233.2 T(olv).96 E 1.235
(ed the messy problems of reading directories by deleting the pri)-.18 F -.3
(va)-.3 G 1.235(te func-).3 F 1.397(tions and using only the C library)90 247.2
R/F2 12/Times-Italic@0 SF(dir)4.397 E(ectory)-.444 E F0 1.397
(\(3\) functions to read directories.)2 F 1.396(The shell)7.397 F -.12(wa)90
261.2 S 3.164(sm).12 G .164(odi\214ed to call the ne)121.04 261.2 R 3.164(wf)
-.3 G(unction)235.212 261.2 Q F2(openqdir)3.164 E F0 .164(instead of calling)
5.164 F F2(opendir)3.164 E F0(directly;)5.164 E F2(open-)3.164 E(qdir)90 275.2
Q F0 .522(passes to)5.522 F F2(opendir)3.522 E F0 3.522(ac)5.522 G(op)219.598
275.2 Q 3.522(yo)-.12 G 3.522(ft)247 275.2 S .522
(he \214le name with the 0200 bit, used by the shell inter)257.854 275.2 R(-)
-.24 E .88
(nally to mark quoted characters \(e.g. the \214rst character of a command ar)
90 289.2 R .881(gument such as)-.216 F F1(\\?*)90 303.2 Q F0
(\), stripped from each character)A(.)-.66 E 3.648 -.96(We a)115 320.8 T 1.728
(lso disco).96 F -.18(ve)-.18 G 1.728(red that the code that implemented ne).18
F -.06(ga)-.18 G 1.727(ted character classes \(for).06 F -.18(ex)90 334.8 S
(ample,).18 E/F3 12/Courier@0 SF([!a-z])3.411 E F0 3.411(\)i)C 3.411(nt)190.83
334.8 S .411(he old shell w)203.577 334.8 R .412(as incorrect and had only w)
-.12 F(ork)-.12 E .412(ed by chance; Henry)-.12 F
(Spencer replaced the incorrect code with rob)90 348.8 Q(ust, w)-.24 E
(orking code.)-.12 E F1 3(4.4. I/O)90 376.8 R(Redir)3 E(ection)-.216 E F0 .537
(The ne)115 394.4 R 3.537(ws)-.3 G .537(hell is prepared to sa)165.094 394.4 R
.897 -.18(ve m)-.24 H .536(ultiple standard descriptors by duplicating them).18
F(to whiche)90 408.4 Q -.18(ve)-.3 G 3(rd).18 G(escriptors abo)160.836 408.4 Q
.36 -.18(ve t)-.18 H(he normal range are free.).18 E .188(I/O redirections no)
115 426 R 3.188(wb)-.3 G(eha)223.576 426 Q .548 -.18(ve a)-.24 H 3.188(so).18 G
.188(ne w)273.512 426 R .188(ould e)-.12 F .188
(xpect: since the empty \214lename refers to)-.18 F .094(the current directory)
90 440 R(,)-.78 E F3(<'')3.094 E F0 .093
(will open the current directory on some systems, and)3.094 F F3(>'')3.093 E F0
(will,)3.093 E(one hopes, f)90 454 Q(ail with an error message.)-.12 E F1 3
(4.5. Name-to-i-number)90 482 R(translations)3 E F0 .438(Use of)115 499.6 R F2
(access)3.438 E F0 .438(is inappropriate in the shell, as one w)5.438 F .439
(ants to check ag)-.12 F .439(ainst the shell')-.06 F(s)-.66 E(ef)90 513.6 Q
(fecti)-.3 E .924 -.18(ve i)-.3 H .563(ds, and unnecessary).18 F 3.563(,a)-.78
G 3.563(so)245.973 513.6 S .563
(ne can easily check the permission bits obtained from)260.204 513.6 R(the)90
527.6 Q F2(stat)4.103 E F0 7.103(.T)2 G 1.103(his is f)145.542 527.6 R 1.103
(aster because each system call, such as)-.12 F F2(access)4.103 E F0(or)6.103 E
F2(stat)4.104 E F0 4.104(,w)2 G 1.104(hich tak)463.26 527.6 R 1.104(es a)-.12 F
.086(\214lename as a parameter must translate it to the \(de)90 541.6 R
(vice-number)-.3 E 3.086(,i)-.48 G .085(-number\) pair used inter)401.684 541.6
R(-)-.24 E 1.808(nally by)90 555.6 R/F4 11/Times-Roman@0 SF(UNIX)4.808 E F0
1.809(to refer to \214les.)4.808 F 1.809(This translation is relati)7.809 F
-.18(ve)-.3 G 1.809(ly slo).18 F 4.809(wb)-.3 G 1.809(ecause it typically)
431.73 555.6 R .461(requires disk accesses, e)90 569.6 R -.18(ve)-.3 G 3.461
(no).18 G 3.461(ns)234.32 569.6 S .461(ystems with)248.449 569.6 R F2(namei)
3.461 E F0 3.46(caches. Still)5.461 F -.12(fa)3.46 G .46(ster w).12 F .46
(ould be to sim-)-.12 F .36(ply try to)90 583.6 R F2 -.24(ex)3.36 G(ec).24 E F0
.36(\(2\) each \214lename in turn, and e)2 F(xamine)-.18 E F2(errno)3.361 E F0
(afterw)5.361 E .361(ard; this will not w)-.12 F(ork)-.12 E(for the)90 597.6 Q
F2(type)3 E F0(\(a.k.a.)5 E F2(whatis)6 E F0 3(\)b)2 G
(uilt-in, though, and we ha)231.4 597.6 Q .36 -.18(ve n)-.24 H(ot done this.)
.18 E F1 3(4.6. Exit)90 625.6 R F2(malloc)115 643.2 Q F0 1.446
(is not an issue in the ne)6.446 F 4.446(ws)-.3 G 1.446(hell, b)292.26 643.2 R
1.446(ut unw)-.24 F 1.446(anted static)-.12 F F2(stdio)4.446 E F0 -.24(bu)6.446
G -.3(ff).24 G 1.445(ers do tak).3 F(e)-.12 E .449(quite a bit of data space.)
90 657.2 R(De\214ning)6.449 E F3 .45(exit\(n\) { _exit\(n\); })3.449 F F0 .45
(to a)3.45 F -.24(vo)-.24 G(id).24 E F2(stdio)3.45 E F0(signi\214-)5.45 E 1.801
(cantly reduces the shell')90 671.2 R 4.801(ss)-.66 G 1.8
(ize, thus reducing the time needed to)225.184 671.2 R F2(fork\(2\))4.8 E F0
1.8(and speeding)6.8 F(command e)90 685.2 Q -.18(xe)-.18 G(cution.).18 E EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Bold@0 SF 3(5. Methods)90 86 R/F1 12/Times-Roman@0 SF(Deb)115
103.6 Q .786(ugging the shell is more dif)-.24 F .787
(\214cult than one might e)-.3 F 3.787(xpect. Initial)-.18 F(deb)3.787 E .787
(ugging w)-.24 F(as)-.12 E(lar)90 117.6 Q .716
(gely by inspired guesses and tedious e)-.216 F .716
(xperimentation, due to the dif)-.18 F .716(\214culty of e)-.3 F(xamin-)-.18 E
(ing multi-me)90 131.6 Q -.06(ga)-.18 G
(byte core dumps, which tend to be uninformati).06 E .36 -.18(ve a)-.3 H -.18
(ny).18 G -.12(wa).18 G -.78(y.).12 G .91(Once the shell w)115 149.2 R .91
(as made to stop catching SIGSEGV)-.12 F 3.91(,i)-1.548 G 3.91(tw)382.822 149.2
S .91(as possible to use deb)398.612 149.2 R(ug-)-.24 E .221(gers to e)90 163.2
R .22(xamine core dumps produced by b)-.18 F .22
(uggy shells and produce stack traces, b)-.24 F .22(ut lack-)-.24 F .413
(ing a truly useful deb)90 177.2 R .413(ugger \(such as)-.24 F/F2 12
/Times-Italic@0 SF(pi)3.413 E F1 3.826(\(9.1\)\), [Car)2 F .413
(gill1986a] we resorted, in the main, to)-.216 F 1.508(printing interesting v)
90 191.2 R 1.508(ariables \(with the shell')-.3 F(s)-.66 E F2(pr)4.508 E(s)-.12
E F1(and)6.508 E F2(prn)4.508 E F1 4.508(,n)2 G(ot)395.14 191.2 Q F2(printf)
4.508 E F1 1.508(\(3\)\) and thinking)2 F 1.834(about the output.)90 205.2 R
1.834(One other helpful technique w)7.834 F 1.834
(as to insert magic numbers into each)-.12 F .169(instance of each rele)90
219.2 R -.3(va)-.3 G .169(nt data structure when the instance w).3 F .169
(as created, then check period-)-.12 F 2.493
(ically for the presence of the number)90 233.2 R 5.493(,a)-.48 G 2.494
(nd clear the number upon destruction of the)294.915 233.2 R 5.308
(instance. This)90 247.2 R 2.308(simple technique alone w)5.308 F 2.307
(as a great help in k)-.12 F 2.307(eeping the shell sane by)-.12 F .532
(detecting corruption and confusion early)90 261.2 R 6.532(.W)-.78 G 3.533(ea)
305.876 261.2 S .533(lso link)320.065 261.2 R .533(ed the shell with a deb)-.12
F .533(ugging v)-.24 F(er)-.18 E(-)-.24 E 1.752(sion of)90 275.2 R F2(malloc)
4.751 E F1 1.751(supplied by Sun \()6.751 F/F3 12/Courier@0 SF
(/usr/lib/debug/malloc.o)A F1 1.751(\), which checks the)B
(arena for consistenc)90 289.2 Q -.78(y.)-.18 G F0 3(6. Conclusions)90 317.2 R
F1(Deb)115 334.8 Q .32(ugging w)-.24 F .321(ould certainly ha)-.12 F .681 -.18
(ve b)-.24 H .321(een easier if the assumptions in the old shell code).18 F
1.333(had been documented; we hope that this paper will sa)90 348.8 R 1.693
-.18(ve s)-.24 H 1.333(hell maintainers man).18 F 4.332(yh)-.18 G(ours.)498.336
348.8 Q .898(The ne)90 362.8 R 3.898(ws)-.3 G .899
(hell appears to be quite portable and has been run on the DEC PDP-11 under)
140.816 362.8 R
(V7, Sun-3 under SunOS 3.x, Sun-4 under SunOS 4.0, and MIPS M/1000.)90 376.8 Q
.121(Our ne)115 394.4 R 3.121(ws)-.3 G .121(hell no)164.262 394.4 R 3.121(wc)
-.3 G .121(ontains comments which describe most of the ne)214.196 394.4 R
(wly-disco)-.3 E -.18(ve)-.18 G(red).18 E
(assumptions which had been hidden in the old shell.)90 408.4 Q(Unfortunately)
115 426 Q 3.053(,t)-.78 G .053(his v)190.929 426 R .053
(ersion is not generally a)-.18 F -.3(va)-.24 G .053(ilable, as it is deri).3 F
-.18(ve)-.3 G 3.054(df).18 G .054(rom Ninth Edi-)448.56 426 R .774(tion code.)
90 440 R .774(The ne)6.774 F 3.774(wv)-.3 G .774(ersion of)196.596 440 R F3
(stak.c)3.774 E F1 3.774(,h)C -.3(ow)299.442 440 S -2.58 -.3(ev e).3 H 1.734
-.48(r, i).3 H 3.774(sn).48 G .773(ot licensed and is reprinted in the)358.05
440 R(Appendix to this paper)90 454 Q(.)-.66 E F0 3(7. Ackno)90 482 R
(wledgements)-.12 E F1 2.561(Henry Spencer of the Uni)115 499.6 R -.18(ve)-.3 G
2.561(rsity of T).18 F(oronto')-.96 E 5.561(sD)-.66 G 2.561
(epartment of Zoology hired the)361.779 499.6 R .384(author to perform the w)90
513.6 R .383(ork described abo)-.12 F -.18(ve)-.18 G 3.383(,c).18 G .383
(ommented on drafts of this paper)314.143 513.6 R 3.383(,r)-.48 G .383(an v)
484.933 513.6 R(ari-)-.3 E 1.628(ous v)90 527.6 R 1.628(ersions of the ne)-.18
F 4.628(ws)-.3 G 1.628(hell as)218.644 527.6 R F3(/bin/sh)4.629 E F1 1.629
(on his machines while we disco)4.629 F -.18(ve)-.18 G 1.629(red ne).18 F(w)-.3
E .842(undocumented properties of the shell, and w)90 541.6 R .842
(as patient while b)-.12 F .842(ugs were found and \214x)-.24 F(ed.)-.18 E
(The Department funded this w)90 555.6 Q(ork.)-.12 E .858
(Cray Research found some of the places in which)115 573.2 R F2(pushstak)3.859
E F1 .859(should ha)5.859 F 1.219 -.18(ve b)-.24 H .859(een used).18 F .707
(in the old shell and repaired them, and \214x)90 587.2 R(ed)-.18 E F2
(pushstak)3.707 E F1 3.707(,i)2 G 3.707(no)364.198 587.2 S .707(rder to mak)
379.905 587.2 R 3.707(et)-.12 G .706(he shell run on)448.89 587.2 R .467(Crays\
, at least some models of which are incapable of restarting instructions which\
 abort)90 601.2 R(due to memory f)90 615.2 Q(aults.)-.12 E .591
(Dennis Ritchie incorporated Cray')115 632.8 R 3.591<738c>-.66 G -.18(xe)296.68
632.8 S 3.591(si).18 G .591(nto the Ninth Edition shell, and ur)319.423 632.8 R
.59(ged the)-.216 F .166
(author to continue attempting to \214x the shell rather than thro)90 646.8 R
.167(wing it out and reimplement-)-.3 F 1.657(ing it.)90 660.8 R 1.657(\(He w)
7.657 F 1.657
(as of course right, in part due to the subtleties of getting details such as)
-.12 F 1.152(quoting and)90 674.8 R F2 -.18(ev)4.152 G(al).18 E F1 1.152
(just right.)6.152 F(Ne)7.152 E -.18(ve)-.3 G 1.153
(rtheless, a future reimplementation of the shell w).18 F(ould)-.12 E 2.278
(bene\214t by using more of the tools a)90 688.8 R -.3(va)-.24 G 2.277
(ilable in the C library and else).3 F 2.277(where, possibly)-.3 F(including)90
702.8 Q F2(yacc)3.714 E F1(and)5.714 E F2(le)3.714 E(x)-.24 E F1 3.714
(.\) Dennis)2 F .714(also pro)3.714 F .715(vided v)-.18 F .715
(ery helpful comments on a draft of this)-.18 F(paper)90 716.8 Q(.)-.66 E EP
%%Page: 9 9
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Roman@0 SF .574(Ian Darwin, Be)115 86 R -.18(ve)-.3 G .574
(rly Erlebacher and T).18 F .573(om Glinos proof-read drafts of this paper and)
-.96 F(contrib)90 100 Q(uted helpful suggestions.)-.24 E(An)115 117.6 Q 3(ye)
-.18 G(rrors remaining in this paper are the responsibility of the author)
143.812 117.6 Q(.)-.66 E/F1 12/Times-Bold@0 SF(Refer)90 145.6 Q(ences)-.216 E
F0(Bourne1978a.)90 166.8 Q 1.676(S. R. Bourne, `)115 180.8 R(`U)-.888 E/F2 10
/Times-Roman@0 SF(NIX)A F0 -.42(Ti)4.676 G 1.676(me-Sharing System: The U).42 F
F2(NIX)A F0(Shell,)4.676 E -.888('')-.84 G/F3 12/Times-Italic@0 SF 1.676
(Bell Sys. T)5.564 F(ec)-1.104 E 1.676(h. J)-.18 F(.)-.3 E F0(,)A -.24(vo)115
194.8 S(l. 57, no. 6, pp. 1971-1990, 1978.).24 E(Car)90 212.4 Q(gill1986a.)
-.216 E 1.776 -.888(T. A)115 226.4 T 3(.C).888 G(ar)150.112 226.4 Q(gill, `)
-.216 E(`The Feel of Pi,)-.888 E -.888('')-.84 G F3(Pr)3.888 E(oc. W)-.54 E
(inter Usenix Conf)-.66 E 3(.1)-.18 G(986)404.2 226.4 Q F0 3(,1)C(986.)434.2
226.4 Q(Johnson1978a.)90 244 Q 1.961(S. C. Johnson and D. M. Ritchie, `)115 258
R(`U)-.888 E F2(NIX)A F0 -.42(Ti)4.961 G 1.961
(me-Sharing System: Portability of C).42 F 1.034(Programs and the U)115 272 R
F2(NIX)A F0(System,)4.034 E -.888('')-.84 G F3 1.034(Bell Sys. T)4.922 F(ec)
-1.104 E 1.034(h. J)-.18 F(.)-.3 E F0 4.035(,v)C 1.035
(ol. 57, no. 6, pp. 2021-2048,)380.493 272 R(1978.)115 286 Q -.3(Ke)90 303.6 S
(rnighan1979a.).3 E 1.387(Brian W)115 317.6 R 4.387(.K)-1.104 G 1.386
(ernighan and Dennis M. Ritchie, `)172.026 317.6 R 1.386
(`UNIX Programming \255 Second Edi-)-.888 F(tion,)115 331.6 Q -.888('')-.84 G
F3(UNIX Pr)3.888 E -.12(og)-.54 G -.18(ra).12 G(mmer').18 E 3(sM)-.48 G
(anual, Se)259.264 331.6 Q(venth Edition)-.18 E F0 3(,J)C(anuary)378.748 331.6
Q 3(,1)-.78 G(979.)422.62 331.6 Q -.3(Ke)90 349.2 S(rnighan1984a.).3 E .543
(Brian W)115 363.2 R 3.543(.K)-1.104 G .543(ernighan and Rob Pik)170.338 363.2
R(e,)-.12 E F3 .543(The UNIX Pr)3.543 F -.12(og)-.54 G -.18(ra).12 G .544
(mming En).18 F(vir)-.48 E(onment,)-.54 E F0(Prentice-)3.544 E(Hall, 1984.)115
377.2 Q -.42(Ko)90 394.8 S(rn1985a.).42 E(Da)115 408.8 Q .42(vid G. K)-.24 F
.42(orn and Kiem-Phong V)-.42 F .42(o, `)-1.548 F .42
(`In Search of a Better Malloc,)-.888 F -.888('')-.84 G F3(Pr)4.307 E .419
(oc. Summer)-.54 F(Usenix Conf)115 422.8 Q 3(.1)-.18 G(985)186.484 422.8 Q F0 3
(,p)C(p. 489-506, June 1985.)216.484 422.8 Q(Ritchie1987a.)90 440.4 Q
(Dennis Ritchie,)115 454.4 Q F3(private communication)3 E F0 3(,1)C(987.)
315.652 454.4 Q(Shannon1988a.)90 472 Q(Bill Shannon,)115 486 Q F3
(private communication)3 E F0 3(,N)C -.18(ove)309.664 486 S(mber).18 E 3(,1)
-.48 G(988.)362.812 486 Q EP
%%Page: 10 10
%%BeginPageSetup
BP
%%EndPageSetup
/F0 12/Times-Bold@0 SF -.3(Ap)90 86 S(pendix: the new stak.c, minus deb).3 E
(ugging #ifdefs)-.24 E/F1 12/Times-Roman@0 SF(This code w)90 103.6 Q
(as all written by the author; it is not subject to an)-.12 E 3(ys)-.18 G
(ource licences.)396.348 103.6 Q/F2 6/Times-Roman@0 SF
(/* replaces @\(#\)stak.c)90 114.2 Q(1.4 */).324 E(/*)90 128.2 Q 1.5(*U)91.5
135.2 S(NIX shell)-1.5 E(*)91.5 142.2 Q 1.5(*S)91.5 149.2 S(tack)-1.5 E
(ed-storage allocation.)-.06 E(*)91.5 156.2 Q 1.5(*M)91.5 163.2 S
(aintains a link)-1.5 E
(ed stack \(of mostly character strings\), the top \(most)-.06 E 1.5(*r)91.5
170.2 S(ecently allocated item\) of which is a gro)-1.5 E
(wing string, which pushstak\(\))-.15 E 1.5(*i)91.5 177.2 S
(nserts into and gro)-1.5 E(ws as needed.)-.15 E(*)91.5 184.2 Q 1.5(*E)91.5
191.2 S(ach item on the stack consists of a pointer to the pre)-1.5 E
(vious item)-.15 E 1.5(*\()91.5 198.2 S
(the "stakbsy" pointer; stakbsy points to the top item on the stack\), an)-1.5
E 1.5(*o)91.5 205.2 S(ptional magic number)-1.5 E 1.5(,a)-.24 G(nd the data.)
-1.5 E(There may be malloc o)3 E -.09(ve)-.09 G(rhead storage).09 E 1.5(*o)91.5
212.2 S 1.5(nt)-1.5 G(op of this.)-1.5 E(*)91.5 219.2 Q 1.5(*P)91.5 226.2 S
(ointers returned by these routines point to the \214rst byte of the data)-1.5
E 1.5(*i)91.5 233.2 S 1.5(nas)-1.5 G
(tack item; users of this module should be una)-1.5 E -.06(wa)-.09 G
(re of the "stakbsy").06 E 1.5(*p)91.5 240.2 S(ointer and the magic number)-1.5
E 3(.T)-.33 G 1.5(oc)175.344 240.2 S(onfuse matters, stakbsy points to the)-1.5
E 1.5(*")91.5 247.2 S(stakbsy" link)-1.5 E
(ed list pointer of the top item on the stack, and the)-.06 E 1.5(*")91.5 254.2
S(stakbsy" link)-1.5 E
(ed list pointers each point to the corresponding pointer)-.06 E 1.5(*i)91.5
261.2 S 1.5(nt)-1.5 G(he ne)-1.5 E(xt item on the stack.)-.09 E
(This all comes to a head in tdystak\(\).)3 E(*)91.5 268.2 Q 1.5(*G)91.5 275.2
S(eof)-1.5 E 1.5(fC)-.15 G(ollyer)-1.5 E(*/)91.5 282.2 Q(/* see also stak.h */)
90 296.2 Q(#include "defs.h")90 310.2 Q(#undef free)90 324.2 Q
(/* refer to free\(3\) here */)180 324.2 Q(#de\214ne STMA)90 338.2 Q
(GICNUM 0x1235)-.24 E(/* stak item magic */)198 338.2 Q(#de\214ne HPMA)90 345.2
Q(GICNUM 0x4276)-.24 E(/* heap item magic */)198 345.2 Q(#de\214ne MA)90 352.2
Q(GICSIZE BYTESPER)-.24 E -.06(WO)-.33 G 23.466(RD /*).06 F -.06(wa)1.5 G 1.5
(so).06 G(nce zero */)-1.5 E(/* imports from libc */)90 366.2 Q -.09(ex)90
373.2 S(tern char *malloc\(\), *realloc\(\);).09 E -.09(ex)90 380.2 S
(tern char *memcp).09 E(y\(\), *strcp)-.06 E(y\(\);)-.06 E(/* forw)90 394.2 Q
(ards */)-.06 E(char *stalloc\(\), *gro)90 401.2 Q(wstak\(\), *getstak\(\);)
-.15 E(unsigned brkincr = BRKINCR;)90 415.2 Q(/* used in stak.h only */)198
415.2 Q(static char *)90 429.2 Q(tossgro)90 436.2 Q 55.32(wing\(\) /*)-.15 F
(free the gro)1.5 E(wing stack */)-.15 E({)90 443.2 Q(if \(stakbsy != 0\) {)108
450.2 Q(/* an)180 450.2 Q 1.5(yg)-.09 G(ro)-1.5 E(wing stack? */)-.15 E(re)126
457.2 Q(gister struct blk *ne)-.09 E(xtitem;)-.09 E(/* v)126 471.2 Q
(erify magic before freeing */)-.09 E
(if \(\(\(int *\)Rcheat\(stakbsy\)\)[1] != STMA)126 478.2 Q(GICNUM\))-.24 E
(error\("tossgro)144 485.2 Q(wing: bad magic on stack"\);)-.15 E
(\(\(int *\)Rcheat\(stakbsy\)\)[1] = 0;)126 492.2 Q(/* erase magic */)216 492.2
Q(/* about to free the ptr to ne)126 506.2 Q(xt, so cop)-.09 E 1.5(yi)-.06 G
1.5<748c>-1.5 G(rst */)-1.5 E(ne)126 513.2 Q(xtitem = stakbsy->w)-.09 E(ord;)
-.06 E(free\(\(char *\)Rcheat\(stakbsy\)\);)126 520.2 Q(stakbsy = ne)126 527.2
Q(xtitem;)-.09 E(})108 534.2 Q(})90 541.2 Q(static char *)90 555.2 Q 38.844
(stalloc\(asize\) /*)90 562.2 R
(allocate requested stack space \(no frills\) */)1.5 E(int asize;)90 569.2 Q({)
90 576.2 Q(re)108 583.2 Q(gister char *ne)-.09 E(wstack;)-.15 E(re)108 590.2 Q
(gister int size = asize;)-.09 E(ne)108 604.2 Q
(wstack = malloc\(\(unsigned\)\(sizeof\(struct blk\) + MA)-.15 E
(GICSIZE + size\)\);)-.24 E(if \(ne)108 611.2 Q(wstack == 0\))-.15 E
(error\(nostack\);)126 618.2 Q(/* stack this item */)108 632.2 Q
(*\(\(struct blk **\)Rcheat\(ne)108 639.2 Q
(wstack\)\) = stakbsy; /* point back at old stack top */)-.15 E
(stakbsy = \(struct blk *\)Rcheat\(ne)108 646.2 Q 6.618(wstack\); /*)-.15 F
(mak)1.5 E 1.5(et)-.06 G(his ne)-1.5 E 1.5(ws)-.15 G(tack top */)-1.5 E(ne)108
653.2 Q(wstack += sizeof\(struct blk\);)-.15 E(/* point at the data */)198
653.2 Q(/* add magic number for v)108 667.2 Q(eri\214cation */)-.09 E
(*\(\(int *\)Rcheat\(ne)108 674.2 Q(wstack\)\) = STMA)-.15 E(GICNUM;)-.24 E(ne)
108 681.2 Q(wstack += MA)-.15 E(GICSIZE;)-.24 E(return ne)108 688.2 Q(wstack;)
-.15 E(})90 695.2 Q(static char *)90 709.2 Q 42.84(grostalloc\(\) /*)90 716.2 R
(allocate gro)1.5 E(wing stack */)-.15 E({)90 723.2 Q(re)338.4 114.2 Q
(gister int size = BRKINCR;)-.09 E(/* \214ddle global v)338.4 128.2 Q
(ariables to point into this \(gro)-.15 E(wing\) stack */)-.15 E
(staktop = stakbot = stakbas = stalloc\(size\);)338.4 135.2 Q(stak)338.4 142.2
Q(end = stakbas + size - 1;)-.06 E(})320.4 149.2 Q(/*)320.4 163.2 Q 1.5(*a)
321.9 170.2 S(llocate requested stack.)-1.5 E 1.5(*s)321.9 177.2 S
(taknam\(\) assumes that getstak just realloc')-1.5 E 1.5(st)-.33 G(he gro)-1.5
E(wing stack,)-.15 E 1.5(*s)321.9 184.2 S 1.5(ow)-1.5 G 1.5(em)-1.5 G
(ust do just that.)-1.5 E(Grump.)3 E(*/)321.9 191.2 Q(char *)320.4 198.2 Q
(getstak\(asize\))320.4 205.2 Q(int asize;)320.4 212.2 Q({)320.4 219.2 Q(re)
338.4 226.2 Q(gister char *ne)-.09 E(wstack;)-.15 E(re)338.4 233.2 Q
(gister int staklen;)-.09 E(/* + 1 is because stak)338.4 247.2 Q
(end points at the last byte of the gro)-.06 E(wing stack */)-.15 E
(staklen = stak)338.4 254.2 Q(end + 1 - stakbas;)-.06 E
(/* # of usable bytes */)428.4 254.2 Q(ne)338.4 261.2 Q(wstack = gro)-.15 E
(wstak\(asize - staklen\);)-.15 E(/* gro)446.4 261.2 Q 1.5(wg)-.15 G(ro)-1.5 E
(wing stack to asize */)-.15 E 5.172(grostalloc\(\); /*)338.4 268.2 R
(allocate ne)1.5 E 1.5(wg)-.15 G(ro)-1.5 E(wing stack */)-.15 E(return ne)338.4
275.2 Q(wstack;)-.15 E(})320.4 282.2 Q(/*)320.4 296.2 Q 1.5(*s)321.9 303.2 S
(et up stack for local use \(i.e. mak)-1.5 E 1.5(ei)-.06 G 1.5(tb)-1.5 G(ig\).)
-1.5 E 1.5(*s)321.9 310.2 S(hould be follo)-1.5 E(wed by `endstak')-.15 E(*/)
321.9 317.2 Q(char *)320.4 324.2 Q(locstak\(\))320.4 331.2 Q({)320.4 338.2 Q
(if \(stak)338.4 345.2 Q(end + 1 - stakbot < BRKINCR\))-.06 E(\(v)356.4 352.2 Q
(oid\) gro)-.12 E(wstak\(BRKINCR - \(stak)-.15 E(end + 1 - stakbot\)\);)-.06 E
(return stakbot;)338.4 359.2 Q(})320.4 366.2 Q(/*)320.4 380.2 Q 1.5(*r)321.9
387.2 S(eturn an address to be used by tdystak later)-1.5 E(,)-.24 E 1.5(*s)
321.9 394.2 S 1.5(oi)-1.5 G 1.5(tm)-1.5 G
(ust be returned by getstak because it may not be)-1.5 E 1.5(*ap)321.9 401.2 S
(art of the gro)-1.5 E(wing stack, which is subject to mo)-.15 E(ving.)-.09 E
(*/)321.9 408.2 Q(char *)320.4 415.2 Q(sa)320.4 422.2 Q(vstak\(\))-.12 E({)
320.4 429.2 Q(assert\(staktop == stakbot\);)338.4 436.2 Q
(/* assert empty stack */)8.238 E(return getstak\(1\);)338.4 443.2 Q(})320.4
450.2 Q(/*)320.4 464.2 Q 1.5(*t)321.9 471.2 S(idy up after `locstak'.)-1.5 E
1.5(*m)321.9 478.2 S(ak)-1.5 E 1.5(et)-.06 G(he current gro)-1.5 E
(wing stack a semi-permanent item and)-.15 E 1.5(*g)321.9 485.2 S(enerate a ne)
-1.5 E 1.5(wt)-.15 G(in)-1.5 E 1.5(yg)-.09 G(ro)-1.5 E(wing stack.)-.15 E(*/)
321.9 492.2 Q(char *)320.4 499.2 Q(endstak\(ar)320.4 506.2 Q(gp\))-.108 E(re)
320.4 513.2 Q(gister char *ar)-.09 E(gp;)-.108 E({)320.4 520.2 Q(re)338.4 527.2
Q(gister char *oldstak;)-.09 E(*ar)338.4 541.2 Q(gp++ = 0;)-.108 E
(/* terminate the string */)4.626 E(oldstak = gro)338.4 548.2 Q(wstak\(-\(stak)
-.15 E(end + 1 - ar)-.06 E 6.072(gp\)\); /*)-.108 F(reduce gro)1.5 E
(wing stack size */)-.15 E 5.172(grostalloc\(\); /*)338.4 555.2 R(alloc. ne)1.5
E 1.5(wg)-.15 G(ro)-1.5 E(wing stack */)-.15 E(return oldstak;)338.4 562.2 Q
(/* perm. addr)1.17 E 1.5(.o)-.33 G 1.5(fo)-1.5 G(ld item */)-1.5 E(})320.4
569.2 Q(/*)320.4 583.2 Q 1.5(*T)321.9 590.2 S
(ry to bring the "stack" back to sa)-1.71 E -.39(v,)-.12 G 1.5(*a)321.9 597.2 S
(nd bring iotemp')-1.5 E 1.5(ss)-.33 G(tack back to iosa)-1.5 E -.39(v.)-.12 G
(*/)321.9 604.2 Q(tdystak\(sa)320.4 611.2 Q .78 -.39(v, i)-.12 H(osa).39 E(v\))
-.12 E(re)320.4 618.2 Q(gister char *sa)-.09 E 26.724(v; /*)-.12 F
(returned by gro)1.5 E(wstak\(\): points at data */)-.15 E(re)320.4 625.2 Q
(gister struct ionod *iosa)-.09 E 3.882(v; /*)-.12 F(an old cop)1.5 E 1.5(yo)
-.06 G 1.5(fi)-1.5 G(otemp \(may be zero\) */)-1.5 E({)320.4 632.2 Q
(rmtemp\(iosa)338.4 639.2 Q 33.624(v\); /*)-.12 F(pop temp \214les */)1.5 E
(if \(sa)338.4 646.2 Q 1.5(v!)-.12 G 1.5(=0&)-1.5 G 1.5(&\()-1.5 G
(\(int *\)Rcheat\(sa)-1.5 E(v\)\)[-1] != STMA)-.12 E(GICNUM\) /* sa)-.24 E 1.5
(v-)-.12 G 1.5(>d)-1.5 G(ata */)-1.5 E(error\("tdystak: bad magic in ar)356.4
653.2 Q(gument"\);)-.108 E(/*)338.4 667.2 Q 1.5(*p)339.9 674.2 S
(op stack to sa)-1.5 E 1.5(v\()-.12 G(if zero, pop e)-1.5 E -.09(ve)-.15 G
(rything\).).09 E 1.5(*s)339.9 681.2 S .24 -.12(av i)-1.5 H 1.5(sap).12 G
(ointer to data, not magic nor stakbsy link.)-1.5 E 1.5(*s)339.9 688.2 S
(takbsy points at the ptr before the data & magic.)-1.5 E(*/)339.9 695.2 Q
(while \(stakbsy != 0 && \(sa)338.4 702.2 Q 1.5(v=)-.12 G 1.5(=0|)-1.5 G(|)-1.5
E(\(char *\)stakbsy != sa)344.4 709.2 Q 1.5(v-s)-.12 G
(izeof\(struct blk\) - MA)-1.5 E(GICSIZE\)\))-.24 E(tossgro)356.4 716.2 Q
17.652(wing\(\); /*)-.15 F(toss the stack top */)1.5 E 23.172
(grostalloc\(\); /*)338.4 723.2 R(ne)1.5 E 1.5(wg)-.15 G(ro)-1.5 E
(wing stack */)-.15 E EP
%%Page: 11 11
%%BeginPageSetup
BP
%%EndPageSetup
/F0 6/Times-Roman@0 SF(})90 79 Q 48.174(stakchk\(\) /*)90 93 R(reduce gro)1.5 E
(wing-stack size if feasible */)-.15 E({)90 100 Q(if \(stak)108 107 Q
(end - staktop > 2*BRKINCR\))-.06 E(/* lots of unused stack headroom */)1.182 E
(\(v)126 114 Q(oid\) gro)-.12 E(wstak\(-\(stak)-.15 E
(end - staktop - BRKINCR\)\);)-.06 E(})90 121 Q(char *)90 135 Q
(/* address of cop)144 135 Q 1.5(yo)-.06 G 1.5(fn)-1.5 G -.15(ew)-1.5 G
(stak */).15 E(cp)90 142 Q(ystak\(ne)-.06 E(wstak\))-.15 E(char *ne)90 149 Q
(wstak;)-.15 E({)90 156 Q(return strcp)108 163 Q(y\(getstak\(strlen\(ne)-.06 E
(wstak\) + 1\), ne)-.15 E(wstak\);)-.15 E(})90 170 Q(char *)90 184 Q(/* ne)144
184 Q 1.5(wa)-.15 G(ddress of gro)-1.5 E(wn stak */)-.15 E(gro)90 191 Q 17.328
(wstak\(incr\) /*)-.15 F(gro)1.5 E 1.5(wt)-.15 G(he gro)-1.5 E
(wing stack by incr */)-.15 E(int incr;)90 198 Q({)90 205 Q(re)108 212 Q
(gister char *oldbsy;)-.09 E(unsigned topof)108 219 Q(f, botof)-.15 E(f, basof)
-.15 E(f;)-.15 E(int staklen;)108 226 Q(if \(stakbsy == 0\))108 240 Q
(/* paranoia */)162 240 Q 5.172(grostalloc\(\); /*)126 247 R(mak)1.5 E 1.5(eat)
-.06 G(ri)-1.5 E(vial stack */)-.15 E
(/* paranoia: during realloc, point at pre)108 261 Q
(vious item in case of signals */)-.15 E(oldbsy = \(char *\)stakbsy;)108 268 Q
(stakbsy = stakbsy->w)108 275 Q(ord;)-.06 E(topof)108 289 Q 1.5(f=s)-.15 G
(taktop - oldbsy;)-1.5 E(botof)108 296 Q 1.5(f=s)-.15 G(takbot - oldbsy;)-1.5 E
(basof)108 303 Q 1.5(f=s)-.15 G(takbas - oldbsy;)-1.5 E(/* + 1 is because stak)
108 317 Q(end points at the last byte of the gro)-.06 E(wing stack */)-.15 E
(staklen = stak)108 324 Q(end + 1 + incr - oldbsy;)-.06 E
(if \(staklen <= sizeof\(struct blk\) + MA)108 338 Q 8.94(GICSIZE\) /*)-.24 F
(paranoia */)1.5 E(staklen = sizeof\(struct blk\) + MA)126 345 Q(GICSIZE;)-.24
E(if \(incr < 0\) {)108 359 Q(/*)126 366 Q 1.5(*V)127.5 373 S 1.5(7r)-1.5 G
(ealloc w)-1.5 E(astes the memory gi)-.06 E -.09(ve)-.15 G 1.5(nb).09 G
(ack when)-1.5 E 1.5(*a)127.5 380 S(sk)-1.5 E
(ed to shrink a block, so we malloc ne)-.06 E 1.5(ws)-.15 G(pace)-1.5 E 1.5(*a)
127.5 387 S(nd cop)-1.5 E 1.5(yi)-.06 G
(nto it in the hope of later reusing the old)-1.5 E 1.5(*s)127.5 394 S
(pace, then free the old space.)-1.5 E(*/)127.5 401 Q(re)126 408 Q
(gister char *ne)-.09 E 1.5(w=m)-.15 G(alloc\(\(unsigned\)staklen\);)-1.5 E
(if \(ne)126 422 Q 1.5(w=)-.15 G 1.5(=N)-1.5 G(IL\))-1.5 E(error\(nostack\);)
144 429 Q(\(v)126 436 Q(oid\) memcp)-.12 E(y\(ne)-.06 E .78 -.39(w, o)-.15 H
(ldbsy).39 E 1.5(,s)-.39 G(taklen\);)-1.5 E(free\(oldbsy\);)126 443 Q
(oldbsy = ne)126 450 Q(w;)-.15 E 1.5(}e)108 457 S(lse {)-1.5 E
(/* get realloc to gro)126 464 Q 1.5(wt)-.15 G
(he stack to match the stack top */)-1.5 E(if \(\(oldbsy = realloc\(oldbsy)126
471 Q 1.5(,\()-.39 G(unsigned\)staklen\)\) == NIL\))-1.5 E(error\(nostack\);)
144 478 Q(})108 485 Q(stak)108 492 Q(end = oldbsy + staklen - 1;)-.06 E
(/* see? points at the last byte */)198 492 Q(staktop = oldbsy + topof)108 499
Q(f;)-.15 E(stakbot = oldbsy + botof)108 506 Q(f;)-.15 E
(stakbas = oldbsy + basof)108 513 Q(f;)-.15 E
(/* restore stakbsy after realloc */)108 527 Q
(stakbsy = \(struct blk *\)Rcheat\(oldbsy\);)108 534 Q(return stakbas;)108 541
Q(/* addr of 1st usable byte */)162 541 Q(})90 548 Q(/* ARGSUSED reqd */)90 562
Q 36.51(addblok\(reqd\) /*)90 569 R(called from main at start only */)1.5 E
(unsigned reqd;)90 576 Q({)90 583 Q(if \(stakbot == 0\))108 590 Q
(/* called from main, 1st time */)162 590 Q 5.172(grostalloc\(\); /*)126 597 R
(allocate initial arena */)1.5 E(/* else w)108 604 Q(on')-.06 E 1.5(th)-.108 G
(appen */)-1.5 E(})90 611 Q(/*)90 625 Q 1.5(*H)91.5 632 S(eap allocation.)-1.5
E(*/)91.5 639 Q(char *)90 646 Q(alloc\(size\))90 653 Q(unsigned size;)90 660 Q
({)90 667 Q(re)108 674 Q(gister char *p = malloc\(MA)-.09 E(GICSIZE + size\);)
-.24 E(if \(p == NIL\))108 688 Q(error\(nospace\);)126 695 Q
(*\(int *\)Rcheat\(p\) = HPMA)108 709 Q(GICNUM;)-.24 E 1.5(p+)108 716 S 1.5(=B)
-1.5 G(YTESPER)-1.5 E -.06(WO)-.33 G 26.118(RD; /*).06 F
(\214ddle ptr for the user */)1.5 E(return p;)108 723 Q(})320.4 79 Q(/*)320.4
93 Q 1.5(*t)321.9 100 S(he shell')-1.5 E 1.5(sp)-.33 G(ri)-1.5 E -.15(va)-.15 G
(te "free" - frees only heap storage.).15 E 1.5(*o)321.9 107 S(nly w)-1.5 E
(orks on non-null pointers to heap storage)-.06 E 1.5(*\()321.9 114 S(belo)-1.5
E 1.5(wt)-.15 G(he data break and stamped with HPMA)-1.5 E(GICNUM\).)-.24 E 1.5
(*s)321.9 121 S 1.5(oi)-1.5 G 1.5(ti)-1.5 G 1.5(s")-1.5 G
(okay" for the shell to attempt to free data on its)-1.5 E 1.5(*\()321.9 128 S
(real\) stack, including its command line ar)-1.5 E(guments and en)-.108 E
(vironment,)-.24 E 1.5(*o)321.9 135 S 1.5(ri)-1.5 G(ts f)-1.5 E(ak)-.06 E 1.5
(es)-.06 G(tak.)-1.5 E 1.5(*t)321.9 142 S(his permits a quick'n')-1.5 E
(dirty style of programming to "w)-.3 E(ork".)-.06 E 1.5(*t)321.9 149 S
(he use of sbrk is relati)-1.5 E -.09(ve)-.15 G(ly slo).09 E .78 -.39(w, b)-.15
H(ut ef).27 E(fecti)-.15 E -.09(ve)-.15 G(.).09 E(*/)321.9 156 Q(shfree\(p\))
320.4 163 Q(re)320.4 170 Q(gister char *p;)-.09 E({)320.4 177 Q -.09(ex)338.4
184 S(tern char *sbrk\(\);).09 E(if \(p != 0 && p < sbrk\(0\)\) {)338.4 198 Q
(/* plausible data se)428.4 198 Q 1.5(gp)-.09 G(tr? */)-1.5 E(re)356.4 205 Q
(gister int *magicp = \(int *\)Rcheat\(p\) - 1;)-.09 E
(/* ignore attempts to free non-heap storage */)356.4 219 Q
(if \(*magicp == HPMA)356.4 226 Q(GICNUM\) {)-.24 E(*magicp = 0;)374.4 233 Q
(/* erase magic */)4.284 E 1.5(p-)374.4 240 S 1.5(=B)-1.5 G(YTESPER)-1.5 E -.06
(WO)-.33 G(RD; /* get orig. ptr back */).06 E(free\(p\);)374.4 247 Q(})356.4
254 Q(})338.4 261 Q(})320.4 268 Q EP
%%Trailer
end
%%EOF
